---
title: 通过文件包含拿下服务器
tags: 
  - web安全
  - 文件包含
  - getshell
categories: web安全
keywords: 'web安全,文件包含,getshell'
description: 通过文件包含拿下服务器
cover: https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.pianshen.com%2Fimages%2F697%2F9a88f04ae145ad4377fff80669db0f11.png&refer=http%3A%2F%2Fwww.pianshen.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1630747539&t=3e0837ebe761272f181318a65342fab2
date: 2020-12-11 10:00:41
---

<meta name="referrer" content="no-referrer"/>

## 概念

文件包含，即包含代码文件。在开发WEB系统的过程中，同样的代码可能要在多个地方使用，例如登录后台之后需要检测用户是否登录，要实现的话需要在每一个后台文件都具有检测登录的代码，这样会导致代码很冗余，耗费了大量的人力物力而且还浪费了服务器资源。在这样的情况下，就开发出了文件包含函数，通过include()、require()、include_once()、require_once()函数，指定对应文件的路径，即可自动加载该文件的代码进行执行。
从开发层面来看，文件包含便利了代码的编写，但是如果没有进行很好地检测，就会产生任意文件包含漏洞。
## 本地文件包含和远程文件包含
       文件包含分为本地文件包含和远程文件包含。本地文件包含，LFI，只能包含服务器上的资源；远程文件包含，RFI，可以通过http协议包含互联网上的资源。
       开启文件包含功能需要在PHP的配置文件php.ini中进行设置：

allow_url_fopen = On/off 表示开启或关闭本地文件包含功能
allow_url_include = On/Off 表示开启或关闭远程文件包含功能

远程文件包含因为危害性更大，可以直接加载互联网上的文件，所以一般该功能是处于关闭状态的；而本地文件包含因为需要减轻代码负担，所以一般都是开启的。如图：
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318142975-cfabd66e-c7d2-429c-ac6d-1e1ca5ed0742.png#align=left&display=inline&height=79&margin=%5Bobject%20Object%5D&originHeight=160&originWidth=839&status=done&style=none&width=415)
## 文件包含函数
文件包含函数有include()、include_once()、require()、require_once()。因为是拼接到代码进行执行，所以被文件包含的文件不论是什么后缀，包含之后都会被当作代码执行。在文件上传中，我们往往写入了一句话木马文件，但是因为白名单，二次渲染，重新更名等措施，使木马文件不能被当作代码执行，所以只是上传到服务器上了。如果服务器还存在文件包含漏洞，可以进行本地文件包含，那么将其包含的路径指定为木马文件，就可以执行了。

文件包含函数之间的区别：
include() //如果被包含的文件不存在，网页报错，但是代码会继续执行
require() //如果被包含的文件不存在，网页报错，代码不会继续执行
include_once()和require_once()
本质上与include()和require()差别不大，就是在包含前查看是否已经包含过了，如果包含过一次了就不再继续包含。

产生这样区别的原理是include和require调用文件的方式和时间不同：
include - PHP运行到include函数的位置然后去调用被包含的文件。
require - PHP在运行前，就先去把被包含的文件的内容提取出来，然后整合成一个新的PHP文件去执行。


## 漏洞-任意文件包含
       如果说单纯是文件包含，那么并不算是漏洞，因为只是包含了相应的代码文件，能够让代码执行的更加快捷，减轻了服务器压力。但是有的时候，因为业务的需要，或者在开发代码的时候为了文件包含的灵活，开发者会将文件包含函数包含的文件路径通过传参来实现。那么，如果我们控制了传参的内容指向我们需要的文件路径，就变成了任意文件包含漏洞，只要那个文件是一个包含了木马的文件，就可以直接获取服务器权限。
## 实战演示
1、打开实例站点，这里看到是通过s参数加载模块回显页面的
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318143514-03a10597-d68e-484d-8647-bfb2118f62b4.png#align=left&display=inline&height=268&margin=%5Bobject%20Object%5D&originHeight=849&originWidth=1314&status=done&style=none&width=415)
2、通过源代码审计工具对于站点源代码进行审计。发现在MyAction.class.php文件中通过id传参拼接my_进行加载模块处理。
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318144021-1fd9660e-5a45-488f-91fc-5230b91fd9be.png#align=left&display=inline&height=179&margin=%5Bobject%20Object%5D&originHeight=480&originWidth=1112&status=done&style=none&width=415)
3、定位display函数，发现继续调用了fetch函数。
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318144659-0f034d91-7eda-431b-a42b-ebeec8a53875.png#align=left&display=inline&height=231&margin=%5Bobject%20Object%5D&originHeight=593&originWidth=1064&status=done&style=none&width=415)
4、继续追踪fetch函数，经分析发现经过了parseTemplateFile函数对其进行了处理，之后直接通过include()进行包含。
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318145056-d8c139ec-8701-48aa-9931-967cf2aeb98b.png#align=left&display=inline&height=248&margin=%5Bobject%20Object%5D&originHeight=725&originWidth=1213&status=done&style=none&width=415)
5、全文追踪找到parseTemplateFile函数，里面检测了模板文件名为空、模板文件名包含@、模板文件名包含：的情况，这些不影响进行文件包含。
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318145516-73fe323b-0c2a-4dc1-a298-50217a0f132d.png#align=left&display=inline&height=128&margin=%5Bobject%20Object%5D&originHeight=380&originWidth=1236&status=done&style=none&width=415)
6、后面发现有个throw分支，需要能够返回变量templateFile，那么就不能进入该分支。定位函数file_exists_case。经分析可以发现这里是对文件名大小写进行判断的，并不影响传入目录进行包含。
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318146009-23cc3ea2-a3f8-48be-8f9c-94f135ac5c9e.png#align=left&display=inline&height=115&margin=%5Bobject%20Object%5D&originHeight=237&originWidth=856&status=done&style=none&width=415)
7、现在漏洞点有了，但是进行包含需要一个含有一句话木马的文件。回到站点，在加载模块处加上任意信息让其报错，可以看到在页面中显示了错误信息提示模块不存在，并且输出了传入的aaaaaa。
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318146301-255c3a10-1929-4d4f-9ec1-b1a8484ed18f.png#align=left&display=inline&height=145&margin=%5Bobject%20Object%5D&originHeight=394&originWidth=1126&status=done&style=none&width=415)
8、查看日志文件，发现日志文件名是通过固定的年_月_日进行命名的，并且文件内容将完整的错误信息记录了下来。
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318146626-9d687e34-3d1d-4881-ba2c-b43c3167113d.png#align=left&display=inline&height=119&margin=%5Bobject%20Object%5D&originHeight=267&originWidth=931&status=done&style=none&width=415)
9、接下来就是想办法通过错误信息将一句话木马写入到日志文件。这里先传了常规的一句话，发现错误信息并没有加载该一句话。不要紧，查看日志文件发现，已经成功写入了一句话木马。
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318147241-16dd66a9-f0e5-40f7-be7f-719f580438cf.png#align=left&display=inline&height=165&margin=%5Bobject%20Object%5D&originHeight=400&originWidth=1007&status=done&style=none&width=415)
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318147808-26ccb09e-7ee1-4573-a5de-6543b6d22b6d.png#align=left&display=inline&height=169&margin=%5Bobject%20Object%5D&originHeight=404&originWidth=990&status=done&style=none&width=415)
10、包含该日志文件，成功输出了里面的内容了，但是当我通过传参1执行phpinfo()函数的时候发现页面没有响应。
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318148361-358ea321-9040-4bc6-9f79-77102066a9ed.png#align=left&display=inline&height=123&margin=%5Bobject%20Object%5D&originHeight=332&originWidth=1122&status=done&style=none&width=415)
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318148740-eb30ee42-ff9d-48aa-a1a2-b148721c757b.png#align=left&display=inline&height=174&margin=%5Bobject%20Object%5D&originHeight=452&originWidth=1076&status=done&style=none&width=415)
11、查看网页url发现我的输入被网站更改了，变成/0/phpinfo()%3B/，应该是传参1在网站后台有记录，是确实存在的，那么重新传一句话木马，此时设置php的传参为aaa。
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318149233-e2b56e29-5059-418a-9009-53024089fa38.png#align=left&display=inline&height=172&margin=%5Bobject%20Object%5D&originHeight=429&originWidth=1033&status=done&style=none&width=415)
12、在加载模块处拼接日志文件再通过&传参aaa=phpinfo();，发现页面成功输出了phpinfo的函数内容。
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318149754-5a507cec-b0c0-4f11-8aca-6f52f8f9cace.png#align=left&display=inline&height=337&margin=%5Bobject%20Object%5D&originHeight=960&originWidth=1182&status=done&style=none&width=415)
13、通过菜刀WEBshell管理工具拿下服务器权限。


![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318150289-82aae539-c225-471b-b6ac-e148f15d311f.png#align=left&display=inline&height=225&margin=%5Bobject%20Object%5D&originHeight=375&originWidth=625&status=done&style=none&width=375)
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318150780-2d387c11-b081-4491-a7ae-dc0baf84b7ee.png#align=left&display=inline&height=218&margin=%5Bobject%20Object%5D&originHeight=619&originWidth=1179&status=done&style=none&width=415)
14、执行系统命令获取当前用户名以及系统信息。
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318151078-deac12cd-82b8-4966-8737-0103af237ad5.png#align=left&display=inline&height=208&margin=%5Bobject%20Object%5D&originHeight=551&originWidth=1099&status=done&style=none&width=415)
